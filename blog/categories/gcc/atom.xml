<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: GCC | Fotis Koutoulakis]]></title>
  <link href="http://NlightNFotis.github.io/blog/categories/gcc/atom.xml" rel="self"/>
  <link href="http://NlightNFotis.github.io/"/>
  <updated>2013-07-24T13:22:21+03:00</updated>
  <id>http://NlightNFotis.github.io/</id>
  <author>
    <name><![CDATA[Fotis Koutoulakis]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[GSOC: Week 5 report]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/07/24/gsoc-week-5-report/"/>
    <updated>2013-07-24T12:36:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/07/24/gsoc-week-5-report</id>
    <content type="html"><![CDATA[<h1>A clue!</h1>

<p><strong>So last week we were left with the compiler test logs and the build results logs that we had to go through to checkout what was the root cause of all these failures in the gccgo test results, and more importantly in the libgo tests.</strong> So I went through the gccgo logs in search for a clue about why this may have happened. Here is the list of all the failures I compiled from the logs:</p>

<p>```</p>

<p>spawn [open &hellip;]^M
doubleselect.x: ./pthread/pt-create.c:167: <strong>pthread_create_internal: Assertion `({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_s      elf_ + 0), ktid); ok; })&lsquo; failed.
FAIL: go.test/test/chan/doubleselect.go execution,  -O2 -g</p>

<p>==========================================================</p>

<p>spawn [open &hellip;]^M
nonblock.x: ./pthread/pt-create.c:167: <strong>pthread_create_internal: Assertion `({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_self_       + 0), ktid); ok; })&lsquo; failed.
FAIL: go.test/test/chan/nonblock.go execution,  -O2 -g</p>

<p>==========================================================</p>

<p>Executing on host: /root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo -B/root/gcc_new/gccbuild/gcc/testsuite/go/../../  -fno-diagnostics-show-caret -fdiagnostics-color=never  -I/root/gcc_new/gccbuild/i68      6-unknown-gnu0.3/./libgo  -fsplit-stack -c  -o split_stack376.o split_stack376.c    (timeout = 300)
spawn /root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo -B/root/gcc_new/gccbuild/gcc/testsuite/go/../../ -fno-diagnostics-show-caret -fdiagnostics-color=never -I/root/gcc_new/gccbuild/i686-unknown-gnu0.      3/./libgo -fsplit-stack -c -o split_stack376.o split_stack376.c<sup>M</sup>
cc1: error: &lsquo;-fsplit-stack&rsquo; currently only supported on GNU/Linux<sup>M</sup>
cc1: error: &lsquo;-fsplit-stack&rsquo; is not supported by this compiler configuration<sup>M</sup>
compiler exited with status 1
output is:
 cc1: error: &lsquo;-fsplit-stack&rsquo; currently only supported on GNU/Linux<sup>M</sup>
 cc1: error: &lsquo;-fsplit-stack&rsquo; is not supported by this compiler configuration<sup>M</sup></p>

<p>UNTESTED: go.test/test/chan/select2.go</p>

<p>==========================================================</p>

<p>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
spawn [open &hellip;]^M
select3.x: ./pthread/../sysdeps/generic/sem-timedwait.c:50: <strong>sem_timedwait_internal: Assertion `({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate       ((</strong>mach_task_self_ + 0), ktid); ok; })&lsquo; failed.
Aborted</p>

<p>FAIL: go.test/test/chan/select3.go execution,  -O2 -g</p>

<p>==========================================================</p>

<p>Executing on host: /root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo -B/root/gcc_new/gccbuild/gcc/testsuite/go/../../ /root/gcc_new/gcc/gcc/testsuite/go.test/test/chan/select5.go  -fno-diagnostics-show-      caret -fdiagnostics-color=never  -I/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo  -O  -w  -pedantic-errors  -L/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo -L/root/gcc_new/gccbuild/i686-unknown-      gnu0.3/./libgo/.libs  -lm   -o select5.exe    (timeout = 300)
spawn /root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo -B/root/gcc_new/gccbuild/gcc/testsuite/go/../../ /root/gcc_new/gcc/gcc/testsuite/go.test/test/chan/select5.go -fno-diagnostics-show-caret -fdiagno      stics-color=never -I/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo -O -w -pedantic-errors -L/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo -L/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.lib      s -lm -o select5.exe<sup>M</sup>
PASS: go.test/test/chan/select5.go -O (test for excess errors)
FAIL: go.test/test/chan/select5.go execution</p>

<p>==========================================================</p>

<p>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
spawn [open &hellip;]^M
bug147.x: ./pthread/../sysdeps/generic/sem-timedwait.c:50: <strong>sem_timedwait_internal: Assertion `({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate       ((</strong>mach_task_self_ + 0), ktid); ok; })&lsquo; failed.
Aborted</p>

<p>FAIL: go.test/test/fixedbugs/bug147.go execution,  -O2 -g</p>

<p>=========================================================</p>

<p>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
spawn [open &hellip;]^M
BUG: bug347: cannot find caller
Aborted</p>

<p>FAIL: go.test/test/fixedbugs/bug347.go execution,  -O0 -g</p>

<p>========================================================</p>

<p>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
spawn [open &hellip;]^M
BUG: bug348: cannot find caller
panic: runtime error: invalid memory address or nil pointer dereference
[signal 0xb code=0x2 addr=0x0]</p>

<p>goroutine 1 [running]:
FAIL: go.test/test/fixedbugs/bug348.go execution,  -O0 -g</p>

<p>========================================================</p>

<p>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
spawn [open &hellip;]^M
mallocfin.x: ./pthread/pt-create.c:167: <strong>pthread_create_internal: Assertion `({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_self      _ + 0), ktid); ok; })&lsquo; failed.
FAIL: go.test/test/mallocfin.go execution,  -O2 -g</p>

<p>=======================================================</p>

<p>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
spawn [open &hellip;]^M
Aborted</p>

<p>FAIL: go.test/test/nil.go execution,  -O2 -g</p>

<p>======================================================</p>

<p>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
spawn [open &hellip;]^M
Aborted</p>

<p>FAIL: go.test/test/recover3.go execution,  -O2 -g</p>

<p>```</p>

<p><em>See a pattern there?</em> Well certainly I do. In several occasions, the root cause for the fail is this:</p>

<p>``` c Assertion fail</p>

<p>Assertion `({ mach_port_t ktid = <strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; </strong>mach_port_deallocate       ((<em>_mach_task_self</em> + 0), ktid); ok; })&lsquo; failed.
```</p>

<p>Hmm&hellip; That&rsquo;s interesting. Let us go through the libgo results too.</p>

<p>```</p>

<p>Test Run By root on Fri Jul 12 17:56:44 UTC 2013
Native configuration is i686-unknown-gnu0.3</p>

<pre><code>    === libgo tests ===
</code></pre>

<p>a.out: ./pthread/pt-create.c:167: <strong>pthread_create_internal: Assertion <code>({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate ((__mach_task_self_ + 0), ktid); ok; })' failed.
../../../gcc/libgo/testsuite/gotest: line 486: 10005 Aborted                 ./a.out -test.short -test.timeout=${timeout}s "$@"
FAIL: bufio
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (10005) - No such process
a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion</code>({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_self<em> + 0), ktid); ok; })&lsquo; failed.
../../../gcc/libgo/testsuite/gotest: line 486: 10637 Aborted                 ./a.out -test.short -test.timeout=${timeout}s &ldquo;$@&rdquo;
FAIL: bytes
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (10637) &ndash; No such process
a.out: ./pthread/pt-create.c:167: <strong>pthread_create_internal: Assertion <code>({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate ((__mach_task_self_ + 0), ktid); ok; })' failed.
../../../gcc/libgo/testsuite/gotest: line 486: 10757 Aborted                 ./a.out -test.short -test.timeout=${timeout}s "$@"
FAIL: errors
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (10757) - No such process
a.out: ./pthread/../sysdeps/generic/sem-timedwait.c:50: __sem_timedwait_internal: Assertion</code>({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_self</em> + 0), ktid); ok; })&rsquo; failed.
Aborted</p>

<p>goroutine 1 [syscall]:
no stack trace available
FAIL: expvar
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (10886) &ndash; No such process
a.out: ./pthread/pt-create.c:167: <strong>pthread_create_internal: Assertion <code>({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate ((__mach_task_self_ + 0), ktid); ok; })' failed.
../../../gcc/libgo/testsuite/gotest: line 486: 11058 Aborted                 ./a.out -test.short -test.timeout=${timeout}s "$@"
FAIL: flag
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (11058) - No such process
a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion</code>({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_self<em> + 0), ktid); ok; })&lsquo; failed.
../../../gcc/libgo/testsuite/gotest: line 486: 11475 Aborted                 ./a.out -test.short -test.timeout=${timeout}s &ldquo;$@&rdquo;
FAIL: fmt
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (11475) &ndash; No such process
a.out: ./pthread/pt-create.c:167: <strong>pthread_create_internal: Assertion <code>({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate ((__mach_task_self_ + 0), ktid); ok; })' failed.
../../../gcc/libgo/testsuite/gotest: line 486: 11584 Aborted                 ./a.out -test.short -test.timeout=${timeout}s "$@"
FAIL: html
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (11584) - No such process
a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion</code>({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_self</em> + 0), ktid); ok; })&rsquo; failed.
../../../gcc/libgo/testsuite/gotest: line 486: 11747 Aborted                 ./a.out -test.short -test.timeout=${timeout}s &ldquo;$@&rdquo;
FAIL: image
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (11747) &ndash; No such process
a.out: ./pthread/pt-create.c:167: <strong>pthread_create_internal: Assertion <code>({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate ((__mach_task_self_ + 0), ktid); ok; })' failed.
../../../gcc/libgo/testsuite/gotest: line 486: 11999 Aborted                 ./a.out -test.short -test.timeout=${timeout}s "$@"
FAIL: io
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (11999) - No such process
a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion</code>({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_self<em> + 0), ktid); ok; })&lsquo; failed.
../../../gcc/libgo/testsuite/gotest: line 486: 12116 Aborted                 ./a.out -test.short -test.timeout=${timeout}s &ldquo;$@&rdquo;
FAIL: log
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (12116) &ndash; No such process
a.out: ./pthread/pt-create.c:167: <strong>pthread_create_internal: Assertion <code>({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate ((__mach_task_self_ + 0), ktid); ok; })' failed.
../../../gcc/libgo/testsuite/gotest: line 486: 13107 Aborted                 ./a.out -test.short -test.timeout=${timeout}s "$@"
FAIL: math
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (13107) - No such process
a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion</code>({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_self</em> + 0), ktid); ok; })&rsquo; failed.
../../../gcc/libgo/testsuite/gotest: line 486: 13271 Aborted                 ./a.out -test.short -test.timeout=${timeout}s &ldquo;$@&rdquo;
FAIL: mime
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (13271) &ndash; No such process
a.out: ./pthread/../sysdeps/generic/sem-timedwait.c:50: <strong>sem_timedwait_internal: Assertion `({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_self_ + 0), ktid); ok; })&lsquo; failed.
Aborted</p>

<p>goroutine 1 [chan receive]:
a.out: ./pthread/../sysdeps/generic/sem-timedwait.c:50: <strong>sem_timedwait_internal: Assertion <code>({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate ((__mach_task_self_ + 0), ktid); ok; })' failed.
panic during panic
testing.RunTestsFAIL: net
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (14234) - No such process
a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion</code>({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_self<em> + 0), ktid); ok; })&lsquo; failed.
../../../gcc/libgo/testsuite/gotest: line 486: 14699 Aborted                 ./a.out -test.short -test.timeout=${timeout}s &ldquo;$@&rdquo;
FAIL: os
timed out in gotest
../../../gcc/libgo/testsuite/gotest: line 484: kill: (14699) &ndash; No such process
a.out: ./pthread/pt-create.c:167: <strong>pthread_create_internal: Assertion `({ mach_port_t ktid = </strong>mach_thread_self (); int ok = thread->kernel_thread == ktid; <strong>mach_port_deallocate ((</strong>mach_task_self</em> + 0), ktid); ok; })&rsquo; failed.
../../../gcc/libgo/testsuite/gotest: line 486: 14860 Aborted                 ./a.out -test.short -test.timeout=${timeout}s &ldquo;$@&rdquo;
FAIL: path
timed out in gotest</p>

<p>&hellip;</p>

<p>runtest completed at Fri Jul 12 18:09:07 UTC 2013
```</p>

<p>That&rsquo;s certainly even more interesting. In case you haven&rsquo;t noticed, it&rsquo;s the same assertion that caused the failures in gccgo test suite. Let us find the offending code, shall we?</p>

<p>``` c libpthread/pthread/pt-create.c</p>

<p>/* Set the new thread&rsquo;s signal mask and set the pending signals to</p>

<pre><code> empty.  POSIX says: "The signal mask shall be inherited from the
 creating thread.  The set of signals pending for the new thread
 shall be empty."  If the currnet thread is not a pthread then we
 just inherit the process' sigmask.  */
</code></pre>

<p>  if (__pthread_num_threads == 1)</p>

<pre><code>err = sigprocmask (0, 0, &amp;sigset);
</code></pre>

<p>  else</p>

<pre><code>err = __pthread_sigstate (_pthread_self (), 0, 0, &amp;sigset, 0);
</code></pre>

<p>  assert_perror (err);</p>

<p>```</p>

<p>This seems to be the code that the logs point to. But no sign of the assertion. After discussing this issue with my peers in #hurd, I was told that the code I was looking for (the failing assertion), is getting inlined via <code>_pthread_self ()</code> and is actually located in <code>libpthread/sysdeps/mach/hurd/pt-sysdep.h</code>.</p>

<p>``` c libpthread/sysdeps/mach/hurd/pt-sysdep.h</p>

<p>extern <strong>thread struct </strong>pthread *___pthread_self;</p>

<h1>define _pthread_self()                                            \</h1>

<pre><code>({                                                         \
  struct __pthread *thread;                                \
                                                           \
  assert (__pthread_threads);                              \
  thread = ___pthread_self;                                \
                                                           \
  assert (thread);                                         \
  assert (({ mach_port_t ktid = __mach_thread_self ();     \
                 int ok = thread-&gt;kernel_thread == ktid;       \
                 __mach_port_deallocate (__mach_task_self (), ktid);\
                 ok; }));                                      \
      thread;                                                  \
     })
</code></pre>

<p>```</p>

<p>So this is what I was looking for. Further discussing it in the weekly IRC meeting, braunr provided me with some more clues:</p>

<blockquote><p>08:38:15 braunr> nlightnfotis: did i answer that ?<br/>
08:38:24 nlightnfotis> braunr: which one?<br/>
08:38:30 nlightnfotis> hello btw :)<br/>
08:38:33 braunr> the problems you&rsquo;re seeing are the pthread resources leaks i&rsquo;ve been trying to fix lately<br/>
08:38:58 braunr> they&rsquo;re not only leaks<br/>
08:39:08 braunr> creation and destruction are buggy <br/>
08:39:37 nlightnfotis> I have read so in <a href="http://www.gnu.org/software/hurd/libpthread.html.">http://www.gnu.org/software/hurd/libpthread.html.</a> I believe it&rsquo;s under Thread&rsquo;s Death right?<br/>
08:40:15 braunr> nlightnfotis: yes but it&rsquo;s buggy<br/>
08:40:22 braunr> and the description doesn&rsquo;t describe the bugs<br/>
08:41:02 nlightnfotis> so we will either have to find a temporary workaround, or better yet work on a fix, right?<br/>
08:41:12 braunr> nlightnfotis: i also told you the work around<br/>
08:41:16 braunr> nlightnfotis: create a thread pool</p></blockquote>

<h1>Work for next week</h1>

<p>This leaves us with next week&rsquo;s work, which is to hack in libpthread&rsquo;s code to attempt to create a thread pool, so that we avoid some of the issues that are present now with the current implementation of the Hurd libpthread code.</p>

<p>It was also suggested by Samuel Thibault (youpi) that I should run the libgo tests by hand and see if I get some more clues, like stack traces. It sounds like a good idea to me, so that&rsquo;s something that I will look into too.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GSOC: Week 4 report]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/07/15/gsoc-week-4-report/"/>
    <updated>2013-07-15T11:43:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/07/15/gsoc-week-4-report</id>
    <content type="html"><![CDATA[<h1>Yeah baby! It builds!</h1>

<p><strong>The highlight of this week&rsquo;s progress was managing to successfully build
gccgo under the Hurd.</strong>
Not only did it compile successfully, it also run its tests, with the
results <a href="http://lists.gnu.org/archive/html/bug-hurd/2013-06/msg00117.html">matching the ones provided by my mentor Thomas Schwinge</a>.
This was a checkpoint in my summer of code project. Successful building of
the compiler meant that I am (happily) in the position to carry on with the
next part (and the main one) of my project, that is, to make sure that
the <strong>go library (libgo) also passes all its tests
and works without any major issues.</strong></p>

<h1>So where are we now?</h1>

<h2>gccgo</h2>

<p>Compiling gccgo on the Hurd was big. But we also had to see how it
compared to the build that was successful on Linux. The most effective
way to compare the two builds, is to check the test results of the two.</p>

<p>Taking a look at the gccgo results on the Hurd, I was delighted to find
that it passed most of its tests. There were few that were failing, but
for the most part, it did well. Below are the test results of gccgo on the Hurd:</p>

<p>```</p>

<pre><code> === go Summary ===
</code></pre>

<h1>of expected passes        5069</h1>

<h1>of unexpected failures    11</h1>

<h1>of expected failures      1</h1>

<h1>of untested testcases     6</h1>

<p>/root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo  version 4.9.0 20130606 (experimental) (GCC)</p>

<p>```</p>

<p>So it&rsquo;s passing 99% of its tests. That&rsquo;s cool. But it could help to take a look
at the tests that are failing, to get an idea of what the fails are, how critical they are, etc</p>

<p>```
nlightnfotis@earth:~/HurdVM/HurdFiles$ grep -v ^PASS: &lt; go.sum
Test Run By root on Thu Jul 11 10:33:34 2013
Native configuration is i686-unknown-gnu0.3</p>

<pre><code>    === go tests ===

    Schedule of variations:
        unix

        Running target unix
        Running /root/gcc_new/gcc/gcc/testsuite/go.dg/dg.exp ...
        Running /root/gcc_new/gcc/gcc/testsuite/go.go-torture/execute/execute.exp ...
        Running /root/gcc_new/gcc/gcc/testsuite/go.test/go-test.exp ...
        FAIL: go.test/test/chan/doubleselect.go execution,  -O2 -g 
        FAIL: go.test/test/chan/nonblock.go execution,  -O2 -g 
        UNTESTED: go.test/test/chan/select2.go
        FAIL: go.test/test/chan/select3.go execution,  -O2 -g 
        FAIL: go.test/test/chan/select5.go execution
        UNTESTED: go.test/test/closure.go
        FAIL: go.test/test/fixedbugs/bug147.go execution,  -O2 -g 
        FAIL: go.test/test/fixedbugs/bug347.go execution,  -O0 -g 
        FAIL: go.test/test/fixedbugs/bug348.go execution,  -O0 -g 
        XFAIL: bug429.go  -O2 -g  execution test
        FAIL: go.test/test/goprint.go execution
        UNTESTED: go.test/test/goprint.go compare
        UNTESTED: go.test/test/init1.go
        FAIL: go.test/test/mallocfin.go execution,  -O2 -g 
        FAIL: go.test/test/nil.go execution,  -O2 -g 
        FAIL: go.test/test/recover3.go execution,  -O2 -g 
        UNTESTED: go.test/test/rotate.go
        UNTESTED: go.test/test/stack.go

                === go Summary ===
</code></pre>

<h1>of expected passes        5069</h1>

<h1>of unexpected failures    11</h1>

<h1>of expected failures      1</h1>

<h1>of untested testcases     6</h1>

<p>/root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo  version 4.9.0 20130606 (experimental) (GCC)
```</p>

<p>Hmm. So these are the failing tests. Before we go through them, it might be a good idea
to check the status of the gccgo tests on the Linux build too. Let&rsquo;s see.</p>

<p>```
nlightnfotis@earth:~$ grep -v ^PASS: &lt; linux_go.sum
Test Run By fotis on Mon Jul 15 10:28:38 2013
Native configuration is i686-pc-linux-gnu</p>

<pre><code>    === go tests ===

    Schedule of variations:
        unix

        Running target unix
        Running /home/fotis/Software/gcc/gcc/testsuite/go.dg/dg.exp ...
        Running /home/fotis/Software/gcc/gcc/testsuite/go.go-torture/execute/execute.exp ...
        Running /home/fotis/Software/gcc/gcc/testsuite/go.test/go-test.exp ...
        UNTESTED: go.test/test/closure.go
        XFAIL: bug429.go  -O2 -g  execution test
        UNTESTED: go.test/test/init1.go
        UNTESTED: go.test/test/rotate.go

                === go Summary ===
</code></pre>

<h1>of expected passes        5183</h1>

<h1>of expected failures      1</h1>

<h1>of untested testcases     3</h1>

<p>/home/fotis/Software/gcc_build/gcc/testsuite/go/../../gccgo  version 4.9.0 20130702 (experimental) (GCC)
```</p>

<p>So, it seems like there are less tests failing here. But wait a minute. Those tests that are failing.
They are the same as with the Hurd build. So I can assume that we are left with 4 less tests to check
regarding their failures (Go on Linux works without any issues,so I guess it would be safe to skip those tests at the moment).
That leaves us with these tests to check:</p>

<p><code>
FAIL: go.test/test/chan/doubleselect.go execution,  -O2 -g
FAIL: go.test/test/chan/nonblock.go execution,  -O2 -g
UNTESTED: go.test/test/chan/select2.go
FAIL: go.test/test/chan/select3.go execution,  -O2 -g
FAIL: go.test/test/chan/select5.go execution
FAIL: go.test/test/fixedbugs/bug147.go execution,  -O2 -g
FAIL: go.test/test/fixedbugs/bug347.go execution,  -O0 -g
FAIL: go.test/test/fixedbugs/bug348.go execution,  -O0 -g
FAIL: go.test/test/goprint.go execution
UNTESTED: go.test/test/goprint.go compare
FAIL: go.test/test/mallocfin.go execution,  -O2 -g
FAIL: go.test/test/nil.go execution,  -O2 -g
FAIL: go.test/test/recover3.go execution,  -O2 -g
UNTESTED: go.test/test/stack.go
</code></p>

<p>Discussing this with my mentor <a href="https://plus.google.com/101468009864620818344">Thomas Schwinge</a> in IRC (#hurd)</p>

<p><code>
&lt;tschwinge&gt; For now, please ignore any failing tests that have »select« in their name -- that is, do file them, but do not spend a lot of time figuring out what might be wrong there.
&lt;tschwinge&gt; The Hurd's select implementation is a bit of a beast, and I don't want you -- at this time -- spend a lot of time on that.  We already know there are some deficiencies, so we should postpone that to later.
</code></p>

<p>So that leaves us with even less tests to check:</p>

<p><code>
FAIL: go.test/test/chan/nonblock.go execution,  -O2 -g
FAIL: go.test/test/fixedbugs/bug147.go execution,  -O2 -g
FAIL: go.test/test/fixedbugs/bug347.go execution,  -O0 -g
FAIL: go.test/test/fixedbugs/bug348.go execution,  -O0 -g
FAIL: go.test/test/goprint.go execution
UNTESTED: go.test/test/goprint.go compare
FAIL: go.test/test/mallocfin.go execution,  -O2 -g
FAIL: go.test/test/nil.go execution,  -O2 -g
FAIL: go.test/test/recover3.go execution,  -O2 -g
UNTESTED: go.test/test/stack.go
</code></p>

<p>Nice. <strong>This narrowed down the list of errors that I have to go through to make sure that gccgo
works as well on the Hurd as it does on Linux.</strong></p>

<h2>libgo</h2>

<p>So, we talked about gccgo, but what about the runtime libraries (libgo)? They are also getting
tested when we run <code>make check-go</code>and seeing as they are a vital part
of enabling programs written on go to run on the Hurd, we ought
to take a look. (This was also the original goal of my project proposal).</p>

<p>So let us see what we have at the libgo.sum:</p>

<p>```
Test Run By root on Fri Jul 12 17:56:44 UTC 2013
Native configuration is i686-unknown-gnu0.3</p>

<pre><code>    === libgo tests ===

    Schedule of variations:
        unix

        Running target unix
        Running ../../../gcc/libgo/libgo.exp ...
        FAIL: bufio
        FAIL: bytes
        FAIL: errors
        FAIL: expvar
        FAIL: flag
        FAIL: fmt
        FAIL: html
        FAIL: image
        FAIL: io
        FAIL: log
        FAIL: math
        FAIL: mime
        FAIL: net
        FAIL: os
        FAIL: path
        FAIL: reflect
        FAIL: regexp
        FAIL: runtime
        FAIL: sort
        FAIL: strconv
        FAIL: strings
        FAIL: sync
        FAIL: syscall
        FAIL: time
        FAIL: unicode
        FAIL: archive/tar
        FAIL: archive/zip
        FAIL: compress/bzip2
        FAIL: compress/flate
        FAIL: compress/gzip
        FAIL: compress/lzw
        FAIL: compress/zlib
        FAIL: container/heap
        FAIL: container/list
        FAIL: container/ring
        FAIL: crypto/aes
        FAIL: crypto/cipher
        FAIL: crypto/des
        FAIL: crypto/dsa
        FAIL: crypto/ecdsa
        FAIL: crypto/elliptic
        FAIL: crypto/hmac
        FAIL: crypto/md5
        FAIL: crypto/rand
        FAIL: crypto/rc4
        FAIL: crypto/rsa
        FAIL: crypto/sha1
        FAIL: crypto/sha256
        FAIL: crypto/sha512
        FAIL: crypto/subtle
        FAIL: crypto/tls
        FAIL: crypto/x509
        FAIL: database/sql
        FAIL: database/sql/driver
        FAIL: debug/dwarf
        FAIL: debug/elf
        FAIL: debug/macho
        FAIL: debug/pe
        FAIL: encoding/ascii85
        FAIL: encoding/asn1
        FAIL: encoding/base32
        FAIL: encoding/base64
        FAIL: encoding/binary
        FAIL: encoding/csv
        FAIL: encoding/gob
        FAIL: encoding/hex
        FAIL: encoding/json
        FAIL: encoding/pem
        PASS: encoding/xml
        FAIL: exp/cookiejar
        FAIL: exp/ebnf
        FAIL: exp/html
        FAIL: exp/html/atom
        FAIL: exp/locale/collate
        FAIL: exp/locale/collate/build
        FAIL: exp/norm
        FAIL: exp/proxy
        FAIL: exp/terminal
        FAIL: exp/utf8string
        FAIL: html/template
        FAIL: go/ast
        FAIL: go/doc
        FAIL: go/format
        FAIL: go/parser
        FAIL: go/printer
        FAIL: go/scanner
        FAIL: go/token
        FAIL: go/types
        FAIL: hash/adler32
        FAIL: hash/crc32
        FAIL: hash/crc64
        FAIL: hash/fnv
        FAIL: image/color
        FAIL: image/draw
        FAIL: image/jpeg
        FAIL: image/png
        FAIL: index/suffixarray
        FAIL: io/ioutil
        FAIL: log/syslog
        FAIL: math/big
        FAIL: math/cmplx
        FAIL: math/rand
        FAIL: mime/multipart
        FAIL: net/http
        FAIL: net/http/cgi
        FAIL: net/http/fcgi
        FAIL: net/http/httptest
        FAIL: net/http/httputil
        FAIL: net/mail
        FAIL: net/rpc
        FAIL: net/smtp
        FAIL: net/textproto
        FAIL: net/url
        FAIL: net/rpc/jsonrpc
        FAIL: old/netchan
        FAIL: old/regexp
        FAIL: old/template
        FAIL: os/exec
        FAIL: os/signal
        FAIL: os/user
        FAIL: path/filepath
        FAIL: regexp/syntax
        FAIL: runtime/pprof
        FAIL: sync/atomic
        FAIL: text/scanner
        FAIL: text/tabwriter
        FAIL: text/template
        FAIL: text/template/parse
        FAIL: testing/quick
        FAIL: unicode/utf16
        FAIL: unicode/utf8

                === libgo Summary ===
</code></pre>

<h1>of expected passes        1</h1>

<h1>of unexpected failures    130</h1>

<p>/root/gcc_new/gccbuild/./gcc/gccgo version 4.9.0 20130606 (experimental) (GCC)
```</p>

<p><strong>Oh boy!</strong> Oh boy! Well, on second thoughts, this was not unexpected.
<strong>This was the core of my GSOC work</strong>. This is how it starts :)</p>

<p>Before this goes any further, maybe we should visit the Linux test results too.</p>

<p>```</p>

<p>Test Run By fotis on Τρι 02 Ιούλ 2013 09:20:20 μμ EEST
Native configuration is i686-pc-linux-gnu</p>

<pre><code>    === libgo tests ===

    Schedule of variations:
        unix

        Running target unix
        Running ../../../gcc/libgo/libgo.exp ...
        PASS: bufio
        PASS: bytes
        ...

                === libgo Summary ===
</code></pre>

<h1>of expected passes        131</h1>

<p>/home/fotis/Software/gcc_build/./gcc/gccgo version 4.9.0 20130702 (experimental) (GCC)
```</p>

<p>Wow. Considering the results from the Hurd, they really are <strong>not</strong> unexpected. <a href="http://darnassus.sceen.net/~hurd-web/open_issues/gccgo/">Remember
that <strong>getcontext, makecontext, setcontext and swapcontext</strong> are not working as expected.</a></p>

<p>And recalling from an email from Ian Lance Taylor (the GCCgo maintainer, and a member of the Go team)
early in the summer:</p>

<blockquote><p>Go does require switching stacks.  A port of Go that doesn&rsquo;t support
goroutines would be useless&mdash;nothing in the standard library would
work</p></blockquote>

<h1>Conclusion / Work for next week.</h1>

<p><strong>So now it comes down to work on implementing correctly the context switching functions.</strong>
Apart from that, going through the test results that fail from gccgo is also something that
is to be done, however I am not sure that it should be a first priority. I also have to go
through go.log to see if there any clues as to why the gccgo tests fail.</p>

<p>Having finally built gccgo on the Hurd, and <strong>more importantly still being on schedule,
(the original one, from my proposal) means that I can now concentrate on the core part of my
project proposal (and the most exciting one too)</strong>, that is proper implementation
of what is <em>blocking effective context switching, which
in its part is blocking goroutines, without which, the go library will not work properly.</em></p>
]]></content>
  </entry>
  
</feed>
