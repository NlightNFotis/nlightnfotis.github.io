
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>GSOC Week 8 (Partial) report - Fotis Koutoulakis</title>
  <meta name="author" content="Fotis Koutoulakis">

  
  <meta name="description" content="Tweet GSOC Week 8 (Partial) Report Aug 12th, 2013 This week was spent studying the go language’s runtime and studying the behaviour of various go &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://NlightNFotis.github.io/blog/2013/08/12/gsoc-week-8-partial-report/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Fotis Koutoulakis" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42432516-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body >
  <header role="banner" id="sidebar">
    <!-- Logo -->
<!-- This is ugly as hell, but does well for now. -->
<!-- TODO: Move this in a seperate stylesheet. -->
<style>
IMG.displayed {
    display: block;
    margin-left: auto;
    margin-right: auto;
    vertical-align: text-bottom;
}
</style>

<IMG class="displayed" src="../../images/me2.png">


<ul id="menu">

  <li class="title">
    <h1 id="title"><a href="/">Fotis Koutoulakis</a></h1>
  </li>


  <li class="subtitle">
    <h2 id="subtitle">I spend my time pretending I know about computers.</h2>
  </li>

  <li class="link">
    <img src="../../images/email.png">
    <a href="/about/">about</a>
  </li>

  <li class="link">
    <img src="../../images/glyphicons_391_twitter_t.png">
    <a href="http://twitter.com/NlightNFotis/">twitter</a>
  </li>


  <li class="link">
    <img src="../../images/glyphicons_381_github.png">
    <a href="http://github.com/NlightNFotis/">github</a>
  </li>

  <li class="link rss">
    <img src="../../images/glyphicons_social_37_rss.png">
    <a href="/atom.xml">rss feed</a>
  </li>
</ul>


<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:NlightNFotis.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>


<!-- Octopress Love -->
<aside id="octopress_linkback">
  <a href="http://octopress.org/">
    <span class="unicode_square">
      <span class="unicode_circle">
        &nbsp;
      </span>
    </span>
    <span class="octopress">Powered by Octopress</span>
  </a>
</aside>


  </header>
  <section id="main">
    <article class="post">
  <div class="sharing-box">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://NlightNFotis.github.io/blog/2013/08/12/gsoc-week-8-partial-report/" data-via="NlightNFotis" data-counturl="http://NlightNFotis.github.io/blog/2013/08/12/gsoc-week-8-partial-report/" data-size="large">Tweet</a>
  
  
  
</div>

  
  <header>
    
      <h2 class="entry-title">GSOC Week 8 (Partial) Report</h2>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-12T10:27:00+03:00" pubdate data-updated="true">Aug 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<p>This week was spent studying the go language’s runtime and studying the behaviour of various go programs when executed under the Hurd. I learnt a variety of new things, and got some 
new clues about the problem.</p>

<h2 id="the-new-libgo-clues">The new libgo clues</h2>

<p>I already know that <em>M’s are the “real” kernel schedulable threads</em> and <em>G’s are the go runtime managed ones (goroutines)</em>. Last time I had gone through the go runtime’s code I had noticed that neither of them get created, so there must be an issue with thread creation. <strong>But since there is at least one of each created during the program’s initialization, how come
most programs are able to run, and issues present themselves when we manually attempt to run a goroutine?</strong></p>

<p>I will admit that the situation looks strange. So I decided to look more into it. Before we go any further, I have to embed the issues I had when I run goroutine powered programs under the Hurd.</p>

<div><div class="CodeRay">
  <div class="code"><pre>root@debian:~/Software/Experiments/go# ./a.out
a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid;
__mach_port_deallocate ((__mach_task_self + 0), ktid); ok; })' failed.
Aborted
</pre></div>
</div>
</div>

<p><code>__pthread_create_internal</code> is a libpthread function that gets called when a new posix thread is instanciated. So we know that when we call a goroutine, apart from the goroutine,
there is at least one kernel thread created, otherwise, if a new goroutine was created, and not a new kernel thread (M) why wasn’t it matched with an existing kernel thread
(remember there is at least one).</p>

<p>That made me look into the go runtime some more. I found a lot of things, that I can not enumerate here, but amongst the most interesting ones, was the following piece of code:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header" style="margin-bottom:-5px;"><span>proc.c </span></figcaption>
 <div class="CodeRay">
  <div class="code"><pre>

<span class="comment">// Create a new m.  It will start off with a call to runtime_mstart.</span>
M*
runtime_newm(<span class="directive">void</span>)
{
        M *mp;
        pthread_attr_t attr;
        pthread_t tid;
        size_t stacksize;
        sigset_t clear;
        sigset_t old;
        <span class="predefined-type">int</span> ret;

<span class="comment">#if 0
        static const Type *mtype;  // The Go type M
        if(mtype == nil) {
                Eface e;
                runtime_gc_m_ptr(&amp;e);
                mtype = ((const PtrType*)e.__type_descriptor)-&gt;__element_type;
        }
#endif</span>

        mp = runtime_mal(<span class="keyword">sizeof</span> *mp);
        mcommoninit(mp);
        mp-&gt;g0 = runtime_malg(-<span class="integer">1</span>, nil, nil);

        <span class="keyword">if</span>(pthread_attr_init(&amp;attr) != <span class="integer">0</span>)
                runtime_throw(<span class="string"><span class="delimiter">&quot;</span><span class="content">pthread_attr_init</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">if</span>(pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED) != <span class="integer">0</span>)
                runtime_throw(<span class="string"><span class="delimiter">&quot;</span><span class="content">pthread_attr_setdetachstate</span><span class="delimiter">&quot;</span></span>);

        stacksize = PTHREAD_STACK_MIN;

        <span class="comment">// With glibc before version 2.16 the static TLS size is taken</span>
        <span class="comment">// out of the stack size, and we get an error or a crash if</span>
        <span class="comment">// there is not enough stack space left.  Add it back in if we</span>
        <span class="comment">// can, in case the program uses a lot of TLS space.  FIXME:</span>
        <span class="comment">// This can be disabled in glibc 2.16 and later, if the bug is</span>
        <span class="comment">// indeed fixed then.</span>
        stacksize += tlssize;

        <span class="keyword">if</span>(pthread_attr_setstacksize(&amp;attr, stacksize) != <span class="integer">0</span>)
                runtime_throw(<span class="string"><span class="delimiter">&quot;</span><span class="content">pthread_attr_setstacksize</span><span class="delimiter">&quot;</span></span>);

        <span class="comment">// Block signals during pthread_create so that the new thread</span>
        <span class="comment">// starts with signals disabled.  It will enable them in minit.</span>
        sigfillset(&amp;clear);

<span class="preprocessor">#ifdef</span> SIGTRAP
        <span class="comment">// Blocking SIGTRAP reportedly breaks gdb on Alpha GNU/Linux.</span>
        sigdelset(&amp;clear, SIGTRAP);
<span class="preprocessor">#endif</span>

        sigemptyset(&amp;old);
        sigprocmask(SIG_BLOCK, &amp;clear, &amp;old);
        ret = pthread_create(&amp;tid, &amp;attr, runtime_mstart, mp);
        sigprocmask(SIG_SETMASK, &amp;old, nil);

        <span class="keyword">if</span> (ret != <span class="integer">0</span>)
                runtime_throw(<span class="string"><span class="delimiter">&quot;</span><span class="content">pthread_create</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> mp;
}
</pre></div>
</div>
 </figure></notextile></div>

<p>This is the code that creates a new kernel thread. Notice the line <code>ret = pthread_create(&amp;tid, &amp;attr, runtime_mstart, mp);</code>. It’s obvious that it creates a new kernel thread,
so that explains why we get the specific error. But what is not explained is that since we do have at least one in program startup, why is this specific error only triggered when
we manually create a go routine?</p>

<h2 id="go-programs-under-the-hurd">Go programs under the Hurd</h2>

<p>Apart from studying Go’s runtime source code, I also run some experiments under the Hurd. I got some very weird results that I am investigating, but I would like to share nonetheless.
Consider the following piece of code:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header" style="margin-bottom:-5px;"><span>hellogoroutines.go </span></figcaption>
 <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">fmt</span><span class="delimiter">&quot;</span></span>

<span class="keyword">func</span> say(s <span class="predefined-type">string</span>) {
    <span class="keyword">for</span> i := <span class="integer">0</span>; i &lt; <span class="integer">5</span>; i++ {
        fmt.Println(s)
    }
}

<span class="keyword">func</span> main() {
    say(<span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>)
    say(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
}
</pre></div>
</div>
 </figure></notextile></div>

<p>A very basic example that can demonstrate goroutines. Now, if we change <strong>one</strong> of the say functions inside main to a goroutine, this happens:</p>

<div><div class="CodeRay">
  <div class="code"><pre>root@debian:~/Software/Experiments/go# ./a.out
a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid;
__mach_port_deallocate ((__mach_task_self + 0), ktid); ok; })' failed.
Aborted
</pre></div>
</div>
</div>

<p><strong>BUT</strong> if we change <strong>BOTH</strong> of these functions to goroutines (<code>go say("world")</code>, <code>go say("hello")</code>), this happens:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
root@debian:~/Software/Experiments/go# ./a.out
root@debian:~/Software/Experiments/go# 
</pre></div>
</div>
 </figure></notextile></div>

<p>Wait a minute. It can’t be! Did it execute correctly? Where is the output? </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
root@debian:~/Software/Experiments/go# echo $?
0
root@debian:~/Software/Experiments/go#
</pre></div>
</div>
 </figure></notextile></div>

<p>It reports that it has executed correctly. But there is no output.</p>

<h2 id="what-i-am-doing-next">What I am doing next</h2>

<p>I will continue reading through the go runtime for some clues. On the more active size, I am writing a custom test case for goroutine testing under the Hurd, while also doing some analysis
on the programs that run there (currently studying the assembly generated for these programs) to see how they differ and why we get this particular behavior.</p>



</article>


    <nav role="navigation" id="pagination">

</nav>
  </section>
  

  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
