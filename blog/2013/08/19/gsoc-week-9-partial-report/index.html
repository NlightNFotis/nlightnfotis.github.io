
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>GSOC Week 9 (Partial) report - Fotis Koutoulakis</title>
  <meta name="author" content="Fotis Koutoulakis">

  
  <meta name="description" content="Tweet GSOC Week 9 (Partial) Report Aug 19th, 2013 This week was revolving around the print debugging in the gccgo runtime in search
for clues &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://NlightNFotis.github.io/blog/2013/08/19/gsoc-week-9-partial-report/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Fotis Koutoulakis" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42432516-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body >
  <header role="banner" id="sidebar">
    <!-- Logo -->
<!-- This is ugly as hell, but does well for now. -->
<!-- TODO: Move this in a seperate stylesheet. -->
<style>
IMG.displayed {
    display: block;
    margin-left: auto;
    margin-right: auto;
    vertical-align: text-bottom;
}
</style>

<IMG class="displayed" src="../../images/me2.png">


<ul id="menu">

  <li class="title">
    <h1 id="title"><a href="/">Fotis Koutoulakis</a></h1>
  </li>


  <li class="subtitle">
    <h2 id="subtitle">I spend my time pretending I know about computers.</h2>
  </li>

  <li class="link">
    <img src="../../images/email.png">
    <a href="/about/">about</a>
  </li>

  <li class="link">
    <img src="../../images/glyphicons_391_twitter_t.png">
    <a href="http://twitter.com/NlightNFotis/">twitter</a>
  </li>


  <li class="link">
    <img src="../../images/glyphicons_381_github.png">
    <a href="http://github.com/NlightNFotis/">github</a>
  </li>

  <li class="link rss">
    <img src="../../images/glyphicons_social_37_rss.png">
    <a href="/atom.xml">rss feed</a>
  </li>
</ul>


<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:NlightNFotis.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>


<!-- Octopress Love -->
<aside id="octopress_linkback">
  <a href="http://octopress.org/">
    <span class="unicode_square">
      <span class="unicode_circle">
        &nbsp;
      </span>
    </span>
    <span class="octopress">Powered by Octopress</span>
  </a>
</aside>


  </header>
  <section id="main">
    <article class="post">
  <div class="sharing-box">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://NlightNFotis.github.io/blog/2013/08/19/gsoc-week-9-partial-report/" data-via="NlightNFotis" data-counturl="http://NlightNFotis.github.io/blog/2013/08/19/gsoc-week-9-partial-report/" data-size="large">Tweet</a>
  
  
  
</div>

  
  <header>
    
      <h2 class="entry-title">GSOC Week 9 (Partial) Report</h2>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-19T11:35:00+03:00" pubdate data-updated="true">Aug 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<p>This week was revolving around the print debugging in the gccgo runtime in search
for clues regarding the creation of new threads under the goruntime, so as to see
if there is something wrong with the runtime itself, or the way the runtime 
interacts with the libpthread.</p>

<h2 id="partial-presentation-of-findings">(partial presentation of) findings</h2>

<p>During print debugging the gccgo runtime, I didn’t notice anything abnormal or 
unusual so far. For example, the code that does trigger the assertion failure
seems to work at least once, since <code>pthread_create()</code> returns <code>0</code> at least once.</p>

<p>This is expected behavior, since we already have stated that there is at least
one <code>M</code> (kernel thread) created at the initialisation of the program’s runtime.</p>

<p>If however, we try to use a <em>go statement</em> in our program, to make usage of a 
goroutine, the runtime still fails at the usual assertion fail, however the 
output of the program is this:</p>

<div><div class="CodeRay">
  <div class="code"><pre>root@debian:~/Software/Experiments/go# ./a.out
[DEBUG] pthread_create returned 0
a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid;
__mach_port_deallocate ((__mach_task_self + 0), ktid); ok; })' failed.
Aborted
</pre></div>
</div>
</div>

<p>The above output can give us some pieces of information:</p>

<ul>
  <li><code>pthread_create()</code> is called at least once.</li>
  <li>it executes successfuly and without errors - libpthread code suggests that 0 is returned upon successful execution and creation of a thread</li>
  <li>However the assertion is still triggered, which we know it’s getting triggered during thread creation.</li>
</ul>

<p>The second bullet point is also being supported by the fact that even if you exe
cute something as simple as hello world in go, a new M is created, so you get
something along the lines of this as an output:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
root@debian:~/Software/Experiments/go# ./a.out
[DEBUG] pthread_create returned 0
Hello World!
root@debian:~/Software/Experiments/go#
</pre></div>
</div>
 </figure></notextile></div>

<p>There is however something that the above piece of code doesn’t tell us, 
but it would be useful to know: <em>How many times did we create a new thread?</em>
So we modify our gcc’s source code to see how many times the runtimes 
attempts to create a new kernel thread (M). This is what we get out of it:</p>

<div><div class="CodeRay">
  <div class="code"><pre>root@debian:~/Software/Experiments/go# ./a.out
[DEBUG] Preparing to create a new thread.
[DEBUG] pthread_create returned 0
a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid;
__mach_port_deallocate ((__mach_task_self + 0), ktid); ok; })' failed.
[DEBUG] Preparing to create a new thread.
aborted.
</pre></div>
</div>
</div>

<p>The code at this point in the runtime is this:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="comment">// Create a new m.  It will start off with a call to runtime_mstart.</span>
M*
runtime_newm(<span class="directive">void</span>)
{
    M *mp;
    pthread_attr_t attr;
    pthread_t tid;
    size_t stacksize;
    sigset_t clear;
    sigset_t old;
    <span class="predefined-type">int</span> ret;

<span class="comment">#if 0
    static const Type *mtype;  // The Go type M
    if(mtype == nil) {
        Eface e;
        runtime_gc_m_ptr(&amp;e);
        mtype = ((const PtrType*)e.__type_descriptor)-&gt;__element_type;
    }
#endif</span>

    <span class="comment">// XXX: Added by fotis for print debugging.</span>
    printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">[DEBUG] Preparing to create a new thread.</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)

    mp = runtime_mal(<span class="keyword">sizeof</span> *mp);
    mcommoninit(mp);
    mp-&gt;g0 = runtime_malg(-<span class="integer">1</span>, nil, nil);

    <span class="keyword">if</span>(pthread_attr_init(&amp;attr) != <span class="integer">0</span>)
        runtime_throw(<span class="string"><span class="delimiter">&quot;</span><span class="content">pthread_attr_init</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">if</span>(pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED) != <span class="integer">0</span>)
        runtime_throw(<span class="string"><span class="delimiter">&quot;</span><span class="content">pthread_attr_setdetachstate</span><span class="delimiter">&quot;</span></span>);

    <span class="comment">// &lt;http://www.gnu.org/software/hurd/open_issues/libpthread_set_stack_size.html&gt;</span>
<span class="preprocessor">#ifdef</span> __GNU__
    stacksize = StackMin;
<span class="preprocessor">#else</span>
    stacksize = PTHREAD_STACK_MIN;

    <span class="comment">// With glibc before version 2.16 the static TLS size is taken</span>
    <span class="comment">// out of the stack size, and we get an error or a crash if</span>
    <span class="comment">// there is not enough stack space left.  Add it back in if we</span>
    <span class="comment">// can, in case the program uses a lot of TLS space.  FIXME:</span>
    <span class="comment">// This can be disabled in glibc 2.16 and later, if the bug is</span>
    <span class="comment">// indeed fixed then.</span>
    stacksize += tlssize;
<span class="preprocessor">#endif</span>

    <span class="keyword">if</span>(pthread_attr_setstacksize(&amp;attr, stacksize) != <span class="integer">0</span>)
        runtime_throw(<span class="string"><span class="delimiter">&quot;</span><span class="content">pthread_attr_setstacksize</span><span class="delimiter">&quot;</span></span>);

    <span class="comment">// Block signals during pthread_create so that the new thread</span>
    <span class="comment">// starts with signals disabled.  It will enable them in minit.</span>
    sigfillset(&amp;clear);

<span class="preprocessor">#ifdef</span> SIGTRAP
    <span class="comment">// Blocking SIGTRAP reportedly breaks gdb on Alpha GNU/Linux.</span>
    sigdelset(&amp;clear, SIGTRAP);
<span class="preprocessor">#endif</span>

    sigemptyset(&amp;old);
    sigprocmask(SIG_BLOCK, &amp;clear, &amp;old);
    ret = pthread_create(&amp;tid, &amp;attr, runtime_mstart, mp);

    <span class="comment">/* XXX: added for debug printing */</span>
    printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">[DEBUG] pthread_create() returned %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, ret);

    sigprocmask(SIG_SETMASK, &amp;old, nil);

    <span class="keyword">if</span> (ret != <span class="integer">0</span>)
        runtime_throw(<span class="string"><span class="delimiter">&quot;</span><span class="content">pthread_create</span><span class="delimiter">&quot;</span></span>);

    <span class="keyword">return</span> mp;
}
</pre></div>
</div>
</div>

<p>We can deduce two things about our situation right now:</p>

<ul>
  <li>There is <strong>at least one</strong> thread successfully created, and there is an attempt
to create another one.</li>
  <li>The second time, there is a failure before pthread_create is called.</li>
</ul>

<h2 id="continuation-of-work">Continuation of work.</h2>

<p>I have been following this course of path the last week. I presented
some of my findings, and hope to soon be able to write an exhaustive
report on what exactly it is that causes the bug.</p>



</article>


    <nav role="navigation" id="pagination">

</nav>
  </section>
  

  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
