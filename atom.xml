<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Fotis Koutoulakis]]></title>
  <link href="http://NlightNFotis.github.io/atom.xml" rel="self"/>
  <link href="http://NlightNFotis.github.io/"/>
  <updated>2014-04-25T19:41:20+03:00</updated>
  <id>http://NlightNFotis.github.io/</id>
  <author>
    <name><![CDATA[Fotis Koutoulakis]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[How the compiler, the Library and the Kernel work - Part 2 ]]></title>
    <link href="http://NlightNFotis.github.io/blog/2014/04/25/how-the-compiler/"/>
    <updated>2014-04-25T18:27:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2014/04/25/how-the-compiler</id>
    <content type="html"><![CDATA[<p>In the previous part of this little series, we talked about the compiler, and what it does
with the header files, in our attempt to demistify their usage. In this part, I want to show you
what&rsquo;s the compiler&rsquo;s output, and how we create our file.</p>

<h1>The compiler&rsquo;s composition</h1>

<p>Generally speaking, a <em>compiler</em> belongs to a family of software called <strong>translators</strong>.
A translator&rsquo;s job is to read some source code in a source language, and generate (translate it to)
some source code in a target language.</p>

<p>Now, you might think that most compilers you know don&rsquo;t do that. You input a (source code) file,
and you get a binary file, ready to run when you want it to. Yes that&rsquo;s what it does, but it&rsquo;s not
the compiler that does all this. If you remember from the last installment of this series,
when you call the compiler like <code>gcc some_file.c</code> or <code>clang some_file.c</code>, in essence you are
calling the compilation driver, with the file as a parameter. The compilation driver then calls
1) the preprocessor, 2) the (actual) compiler, 3) the assembler and last but not least the linker.
At least when it comes to gcc, these pieces of software are called <code>cpp</code>, <code>cc1</code>,
<code>gas</code> (executable name is <code>as</code>)  and <code>collect2</code> (executable name is <code>ld</code>) respectively.</p>

<p>From that little software collection up top, that we call the compiler, we can easily take notice
of at least 3 (yeah, that&rsquo;s right) translators, that act as we mentioned earlier,
that is take some input in a source language, and produce some output to a target language.</p>

<p>The first is the preprocessor. The preprocessor accepts source code in C as a source language,
and produces source code again in C (as a target language), but with the output having various
elements of the source code resolved, such as header file inclusion, macro expansion, etc.</p>

<p>The second is the compiler. The compiler accepts (in our case) C source code, as a source language,
and translates it to some architecture&rsquo;s assembly language. In my case, when I talk about the
compiler, I&rsquo;m gonna assume that it produces x86 assembly.</p>

<p>The last one, is the assembler, which accepts as input some machine&rsquo;s architecture assembly
language, and produces what&rsquo;s called binary, or object representation of it, that is it translates
the assembly mnemonics directly to the bytes they correspond to, in the target architecture.</p>

<p>At this point, one could also argue that the linker is also a translator, accepting binary, and
translating it to an executable file, that is, resolving references, and fitting the binary code
on the segments of the file that is to be produced. For example, on a typical GNU/Linux system,
this phase produces the executable ELF file.</p>

<h1>The (actual) compiler&rsquo;s output: x86 assembly.</h1>

<p>Before we go any further, I would like to show you what the compiler really creates:</p>

<p>For the typical hello world program we demonstrated in our first installment, the compiler
will output the following assembly code:</p>

<figure class='code'><figcaption><span>hello.S</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'>  <span class="na">.file</span>   <span class="s">&quot;hello.c&quot;</span>
</span><span class='line'>  <span class="na">.section</span>    <span class="no">.rodata</span>
</span><span class='line'><span class="nl">.LC0:</span>
</span><span class='line'>  <span class="na">.string</span> <span class="s">&quot;Hello world!&quot;</span>
</span><span class='line'>  <span class="na">.text</span>
</span><span class='line'>  <span class="na">.globl</span>  <span class="no">main</span>
</span><span class='line'>  <span class="na">.type</span>   <span class="no">main</span><span class="p">,</span> <span class="na">@function</span>
</span><span class='line'><span class="nl">main:</span>
</span><span class='line'>  <span class="nf">pushq</span>   <span class="nv">%rbp</span>
</span><span class='line'>  <span class="nf">movq</span>    <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
</span><span class='line'>  <span class="nf">subq</span>    <span class="no">$16</span><span class="p">,</span> <span class="nv">%rsp</span>
</span><span class='line'>  <span class="nf">movl</span>    <span class="nv">%edi</span><span class="p">,</span> <span class="p">-</span><span class="mi">4</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">movq</span>    <span class="nv">%rsi</span><span class="p">,</span> <span class="p">-</span><span class="mi">16</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">movl</span>    <span class="no">$.LC0</span><span class="p">,</span> <span class="nv">%edi</span>
</span><span class='line'>  <span class="nf">call</span>    <span class="no">puts</span>
</span><span class='line'>  <span class="nf">movl</span>    <span class="no">$0</span><span class="p">,</span> <span class="nv">%eax</span>
</span><span class='line'>  <span class="nf">leave</span>
</span><span class='line'>  <span class="nf">ret</span>
</span><span class='line'>  <span class="na">.size</span>   <span class="no">main</span><span class="p">,</span> <span class="no">.-main</span>
</span><span class='line'>  <span class="na">.ident</span>  <span class="s">&quot;GCC: (GNU) 4.8.2 20131212 (Red Hat 4.8.2-7)&quot;</span>
</span><span class='line'>  <span class="na">.section</span>    <span class="no">.note.GNU-stack</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="na">@progbits</span>
</span></code></pre></td></tr></table></div></figure>


<p>To produce the above file, we had to use the following gcc invocation command:
<code>gcc -S -fno-asynchronous-unwind-tables -o hello.S hello.c</code>.
We used <code>-fno-asynchronous-unwind-tables</code> to remove <code>.cfi</code> directives, which tell <code>gas</code>
(the gnu assembler) to emit Dwarf Call Frame Information tags, which are used to reconstruct
a stack backtrace when a frame pointer is missing.</p>

<p>For more usefull compilation flags, to control the intermediary compilation flow, try these:</p>

<ul>
<li><code>-E</code>: stop after preprocessing, and produce a *.i file</li>
<li><code>-S</code>: we used this, stop after the compiler, and produce a *.s file</li>
<li><code>-c</code>: stop after the assembler, and produce a *.o file.</li>
</ul>


<p>The default behaviour is to use none, and stop after the linker has run. If you want to run a
full compilation and keep all the intermediate files, use the <code>-save-temps</code> flag.</p>

<h1>From source to binary: the assembler.</h1>

<p>The next part of the compilation process, is the assembler. We have already discussed what
the assembler does, so here we are going to see it in practice. If you have followed so far,
you should have two files, a <code>hello.c</code>, which is the hello world&rsquo;s C source code file,
and a <code>hello.S</code> which is what we created earlier, the compiler&rsquo;s (x86) assembly output.</p>

<p>The assembler operates on that last file as you can imagine, and to see it running, and emit
binary, we need to invoke it like this: <code>as -o hello.bin hello.S</code>, and produces this:</p>

<figure class='code'><figcaption><span>hello.bin</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objdump'><span class='line'><span class="x">ELF\00\00\00\00\00\00\00\00\00\00&gt;\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\F0\00\00\00\00\00\00\00\00\00\00\00@\00\00\00\00\00@\00\00\00UH\89\E5H\83\EC\89}\FCH\89u\F0\BF\00\00\00\00\E8\00\00\00\00\B8\00\00\00\00\C9\C3Hello world!\00\00GCC: (GNU) 4.8.2 20131212 (Red Hat 4.8.2-7)\00\00.symtab\00.strtab\00.shstrtab\00.rela.text\00.data\00.bss\00.rodata\00.comment\00.note.GNU-stack\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00 \00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00@\00\00\00\00\00\00\00 \00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\B8\00\00\00\00\00\000\00\00\00\00\00\00\00  \00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00&amp;\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00`\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00,\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00`\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\001\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00`\00\00\00\00\00\00\00</span>
</span><span class='line'><span class="x">\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\009\00\00\00\00\00\000\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00m\00\00\00\00\00\00\00-\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00B\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\9A\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\9A\00\00\00\00\00\00\00R\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\B0\00\00\00\00\00\00\F0\00\00\00\00\00\00\00</span>
</span><span class='line'><span class="x">\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00  \00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\A0\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\F1\FF\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00 \00\00\00\00\00\00\00\00\00\00\00\00\00 \00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00hello.c\00main\00puts\00\00\00\00\00\00\00\00\00\00\00\00\00</span>
</span><span class='line'><span class="x">\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00  \00\00\00\FC\FF\FF\FF\FF\FF\FF\FF</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Last but not least: the linker</h1>

<p>We saw what the assembler emits, which is to say, binary code. However, that binary code
still needs further processing. To explain that, we need to go back a little.</p>

<p>In our first installment of the series, we said that when you call a function like <code>printf()</code>,
the compiler only needs its prototype to do type checking and ensure that you use it legally.
For that you include the header file <code>stdio.h</code>. But since that contains the function prototype only,
where is the source code for that function? Surely, it must be somewhere, since it executes
successfully to begin with, but we haven&rsquo;t met the source code for printf so far, so where is it?</p>

<p>The function&rsquo;s source code is located in the <code>.so</code> (shared object) of the standard C library,
which in my system (Fedora 19, x64) is <code>libc-2.17.so</code>. I don&rsquo;t want to expand on that further,
as I plan to do so on the next series installment, however, what we have said so far is enough
for you to understand the linker&rsquo;s usage:</p>

<p>The linker resolves the undefined (thus far) reference to printf, by finding the reference to
the printf symbol and (in layman&rsquo;s talk)
making a pointer to point to it so that execution can jump to printf&rsquo;s code
when we have to do that during our program&rsquo;s execution.</p>

<p>To invoke the linker on our file, <a href="https://sourceware.org/binutils/docs-2.20/ld/Options.html#Options">at least according to it&rsquo;s documentation</a>,
we should do the following: <code>ld -o hello.out /lib/crt0.o hello.bin -lc</code>. Then we should
be able to run the file like this: <code>./hello.out</code>.</p>

<h1>Epilogue</h1>

<p>That&rsquo;s this end of this part 2 of my series that explains how your code turns into binary, and how
your computer (at least when it comes to the software side) runs it. In part 3, I am going to discuss
in greater length, the C library, and the kernel.</p>

<h2>References</h2>

<ul>
<li><a href="http://stackoverflow.com/questions/3564752/what-is-cfi-and-lfe-in-assembly-code-produced-by-gcc-from-c-program">StackOverflow: What is .cfi and .LFE in assembly code produced by GCC from c++ program?</a></li>
<li><a href="http://blog.lxgcc.net/?p=181">GCC front-end (1): driver vs. compiler</a></li>
<li><a href="http://wiki.osdev.org/GAS">GAS</a></li>
<li><a href="https://sourceware.org/binutils/docs-2.20/ld/"> ld: Binutils documentation</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[My Linux from Scratch Experience]]></title>
    <link href="http://NlightNFotis.github.io/blog/2014/02/23/my-linux-from-scratch-experience/"/>
    <updated>2014-02-23T20:59:00+02:00</updated>
    <id>http://NlightNFotis.github.io/blog/2014/02/23/my-linux-from-scratch-experience</id>
    <content type="html"><![CDATA[<p>The past two to three days, I have been busy with creating my very own Linux distribution
using the well known <a href="http://www.linuxfromscratch.org">Linux from Scratch</a>. This post is
an accounting of my experience with the process, what I liked, what I did learn from that,
what was surprising to me and more.</p>

<h1>Linux from Scratch: An introduction</h1>

<p>If you are here, then you most likely already know what <a href="http://www.linuxfromscratch.com/">linux from scratch</a>
is, but for the sake of completeness (or in the case that you don&rsquo;t know what it is, but are
so keen on learning)  I will provide an introduction about it here.</p>

<p>Linux from scratch is a book (from now on, <em>lfs</em>), providing a series of steps that guide you to the creation of
a fully function GNU/Linux distribution. Although the original book creates a &ldquo;barebones&rdquo;
distribution, with only fundamental tools in it, the distribution created provides a fine
enviroment for further experimentation or customization.</p>

<p>Apart from the basic book, the lfs project also has 3-4 books to read if you want to extend
the basic system (such as blfs, Beyond Linux from Scratch) or if you want to automate the process,
create a distribution that is more secure, or how to cross-compile an lfs system for different machines.</p>

<h1>My experience with building LFS</h1>

<h2>A small introduction about my background</h2>

<p>I have been a UNIX (-like) systems (full-time) user for about 2.5 years now. During that time
I had seen myself from being what you would call a Linux newbie, not knowing how to use
a system without a GUI installed (have I mentioned that Ubuntu was my favourite distribution) to being an arguably experienced UNIX programmer, trying to learn more about the
various aspects of UNIX systems, and delving deeper and deeper into them every day
(while also feeling pain if using something other than a UNIX like system).</p>

<p>During that time, I have learned about the Unix way of working with the system, using the shell and the system&rsquo;s toolchain to write software and other wise manipulate the system. I
ditched my old knowledge about IDEs and GUIs, and set out to master the command line and the associated tools (Anecdote: I remember, when I first came from to Unix from Windows, to searching the net for a C/C++ IDE to do development.) I remember reading about
how people worked another way in Unix land, using an editor, and the shell to work, and I
decided to force myself to learn to work that way. I still remember trying to use vim and gcc,
and ending up liking this way better because it seemed a more natural way to interact with
the software development process, than using a ide and pressing the equivalent of a &ldquo;play&rdquo;
button, so that magic ensues for the next few seconds until I have a result.</p>

<p>Time has passed since then, and going through hours and hours of reading and working with
the system, I did learn quite a lot about it. My Google Summer of Code experience in 2013
expanded my system knowledge even further (that&rsquo;s what you get when you have to work
with the system kernel, the C library and a compiler).</p>

<p>But in all that time, of using Unix like systems, I never had the chance to create one myself.
And although my background did allow me to know quite a few things of the inner workings
of a system like that, I never actually saw all these software systems combining in front
of my very eyes to create that beauty we know as a GNU/Linux distribution. And that left
me a bad taste, because I knew what was happening, but I wanted to see it happen right
in front of my eyes.</p>

<p>Knowing about the existence of lfs, and not actually going through it also made matters worse
for me, as I knew that I could actually &ldquo;patch&rdquo; that knowledge gap of mine, but I never really
tried to do that. I felt that I was missing on a lot, and that lfs would be instrumental to my
understanding of a Linux system. Having gone through that some years ago, and getting
stuck at the very beginning had also created an innate fear in me, that it was something
that would be above my own powers.</p>

<p>Until two days ago, when I said to myself: &ldquo;You know what? I have seen and done a lot
of things in a UNIX system. I am now much more experienced than I was when I last did it.
And I know I want to at least try it, even if it will only give me nothing but infinite confusion
Because if I do manage to get it, I will learn so many more things, or at least get assured
that my preexisting knowledge was correct&rdquo; And that thought was the greatest motive I had
to do that in a fairly long time.</p>

<p>So, I sat at my desk, grabbed a cup of coffee and off I went!</p>

<h2>The process</h2>

<h3>Preparation and the temporary toolchain</h3>

<p>The book is itself several chapters long, each of which perform another &ldquo;big step&rdquo; in the
creation of the distribution.</p>

<p>The first few chapters are preparatory chapters, where you ensure the integrity of the
building environment, and download any building dependencies you may be lacking,
create a new partition that will host the lfs system, and create the user account that
will do the building of the temporary toolchain.</p>

<p>The temporary toolchain building is a more exciting process. In essence
you compile and collect several pieces of software that will later be used
to compile the distribution&rsquo;s toolchain and other software.</p>

<p>You start of with building binutils, and that is to get a working assembler and linker.
After having a working assembler and linker, you proceed with compiling <code>gcc</code>.
Next on is unpacking the linux headers, so that you can compile (and link against them)
the glibc.</p>

<p>Having the basic parts of the toolchain compiled, you then proceed with installing other
software that is needed in the temporary toolchain, like <code>gawk</code>, <code>file</code>, <code>patch</code>, <code>perl</code>
etc.</p>

<h3>Building the main system</h3>

<p>After getting done with the temporary toolchain, you then <code>chroot</code> into the lfs partition.
You start of with creating the needed directories (like <code>/bin</code>, <code>/boot</code>, <code>/etc</code>, <code>/home</code> etc)
and then continue with building the distribution software, utilising the temporary toolchain.
For instance, you construct a new <code>gcc</code>, you compile <code>sed</code>, <code>grep</code>, <code>bzip</code>, the <code>shadow</code>
utility that manages the handling of passwords etc, all while making sure that things don&rsquo;t
break, and running countless tests (that sometimes take longer than what the package
took to compile) to ensure that what you build is functional and reliable.</p>

<h3>Final configuration</h3>

<p>Next one on the list, is the various configuration files that reside in <code>/etc</code>, and the setup
of <code>sysvinit</code>, the distribution&rsquo;s <code>init</code> system.</p>

<p>Last, but not least, you are compiling the linux kernel and setting up grub so that the
system is bootable.</p>

<p>At this point, if all has gone well, and you reset, you should boot into your new lfs system.</p>

<h1>What did I gain from that?</h1>

<p>Building lfs was a very time consuming process for me. It must have taken about 7-8
hours at the very least. Not so much because of the compilation and testing (I was compiling
with <code>MAKEFLAGS='-j 4'</code> on a Core i5), but because I was didn&rsquo;t complete some steps
correctly, and later needed to go back and redo them, along with everything that followed,
along with the time it took to research some issues, programs or various other things
before I did issue a command at the shell.</p>

<p>Now if I were to answer the question &ldquo;What did I gain from that&rdquo;, my answer would be
along the lines of &ldquo;Infinite confusion, and some great insight at some points&rdquo;.</p>

<p>To elaborate on that,</p>

<ul>
<li>lfs mostly served as a reassurance that indeed, what I did know
about the system was mostly correct.</li>
<li>I did have the chance to see the distribution
get built right before my eyes, which was something I longed for a great amount of time.</li>
<li>It did make me somewhat more familiar with the <code>configure &amp;&amp; make &amp;&amp; make install</code>
cycle</li>
<li>It made me realise that the directories in the system are the simple result of a <code>mkdir</code> command, and that configuration files in the <code>/etc/folder</code> are handwritten plain files. (<em>yeah, I feel stupid about that one &ndash; I don&rsquo;t know what I was expecting.</em> This was probably the result of the &ldquo;magic involved&rdquo; that the distro making process entailed for me)</li>
<li>I got to see the specific software that is needed to create a distribution, and demonstrate to me how I can build it, customize that build, or even change that software to my liking</li>
<li>And last but not least, something that nearly every lfs user says after a successful try:
I knew that package managers did a great many things in order to maintain the system, and that much
of the work I would normally have to do was done nearly automatically
but boy, was I underestimating them. After lfs, I developed a new appreciation for a
good package manager.</li>
</ul>


<h1>Epilogue</h1>

<p><em>Lfs was, for the most part, a great experience.</em> <strong>As a knowledge expander, it works great.</strong>
<strong>As a system that you keep and continue to maintain? I don&rsquo;t know.</strong> I know that people have
done that in the past, but I decided against maintaining my build, as I figured it would be
very time consuming, and that if I ever wanted to gain the experience of maintaining a distro,
I would probably fork something like <a href="http://www.crux.nu">Crux</a>.</p>

<p>In the end if you ask me if I can recommend that to you, I will say that I&rsquo;m not so sure.
<strong>It will provide you with some insight into the internals of a GNU/Linux distribution, but it
won&rsquo;t make you a better programmer as some people claim</strong> (most of the process revolves
around the <code>configure &amp;&amp; make &amp;&amp; make install</code> cycle, and some conf files handwriting).</p>

<p><strong>In the end, it is yourself who you should ask. Do you want that knowledge? Is it worth the hassle for you?
Do you want the bragging rights? Are you crazy enough to want to maintain it?</strong>
<em>These are all questions that you get as many answers to them as the people you ask.</em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How the compiler, the Library and the kernel work - Part 1]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/12/12/how-the-compiler/"/>
    <updated>2013-12-12T16:13:00+02:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/12/12/how-the-compiler</id>
    <content type="html"><![CDATA[<p>Before we get any further, it might be good if we provided some context.</p>

<h1>Hello world. Again.</h1>

<figure class='code'><figcaption><span>helloworld.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Hello world!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Every user space programmer, has written a hello world program. Only god knows how many times this program
has been written. Yet, most programmers&#8217; knowledge of the program is limited to something along the lines of:</p>

<blockquote><ul>
<li>It sends the string passed as a parameter to the system to print.</li>
<li>It takes the printf function from stdio.h and prints the string</li>
</ul>
</blockquote>

<p>and various other things, which are anywhere between plain wrong, or partially correct.</p>

<p><strong> So why not demistify the process? </strong></p>

<h1>Enter the C preprocessor.</h1>

<p>You may have heard of the C Preprocessor. It&rsquo;s the first stage of a c or c++ file compilation,
and it&rsquo;s actually responsible for things such as <strong>inclusion of header files</strong> (it does so by replacing
<code>#include &lt;header.h&gt;</code> with the content of this file, and the file it includes recursively),
<strong>macro expansion</strong> (such as the famous comparison of two numbers (a greater than b)
<code>#define gt(a, b) ((a &gt;= b) ? 1 : 0)</code>), <strong>conditional compilation</strong> (things such as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#ifdef WIN32 </span>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;We are on windows</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>amongst others. You can see it for yourself. Write the hello world program, and pass it to cpp: <code>cpp hello_world.c</code></p>

<p>So now that we know what it does it&rsquo;s time to demistify a common myth regarding it: <em>Some people believe
that the header files include the function to be called.</em>. <strong>That&rsquo;s wrong.</strong> What it does include is
<strong>function prototypes</strong> (and some type definitions, etc) <strong>only</strong>. It doesn&rsquo;t include the body of the function
to be called.</p>

<p>Some people are quite surprised by that fact. In fact, it isn&rsquo;t, if you get to understand what the compiler
does with it.</p>

<h1>Say hello to the compiler.</h1>

<p>Here we are gonna unmask another pile of misconceptions. First of all, some people think that when they call
<code>gcc</code> on the command line they are actually calling the compiler. <strong>They are not.</strong> <em>In fact they are calling
the software commonly called <strong>the compilation driver</strong>, whose job is to run all the software needed to fully
turn source to binary, including preprocessors, the actual compiler, an assembler and finally the linker</em></p>

<p>Having said that, the actual compiler that&rsquo;s getting called when you call <code>gcc</code> is called <code>cc1</code>. You may have seen it some times when the driver reports errors. Wanna take a look at it, to make sure I&rsquo;m not lying to you?
(Hint: I&rsquo;m not!) Fair enough. Why don&rsquo;t you type this in the command line: <code>gcc -print-prog-name=cc1</code>. It should tell you where the actual compiler is located in your system.</p>

<p>So now that we have this (misconception) out of our minds, we can continue with our analysis. Last time we talked
about it, we said that the header files include <strong>prototypes</strong> and not the whole function.</p>

<p>You may know that in C, you usually declare a function, before you use it. The primary reason for doing this
is to provide the compiler with the ability to perform <strong>type checking</strong>, that is to check that the arguments
passed are correct, both in number, and in type, and to verify that the returned value (assuming there is one)
is being used correctly. Below is a program that demonstrates the function prototype:</p>

<figure class='code'><figcaption><span>prototype.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">add_nums</span> <span class="p">(</span><span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">second</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="n">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;5 + 5 results in %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">add_nums</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">add_nums</span> <span class="p">(</span><span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">second</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">first</span> <span class="o">+</span> <span class="n">second</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this particular example, the prototype gives the compiler a wide variety of information. It tells it
that function <code>add_nums</code> takes two int arguments and returns an integer to the calling function. Now the
compiler can verify that I am passing correct arguments to it when I call it inside printf. If I don&rsquo;t include
the function prototype, and do something slightly evil such as calling <code>add_nums</code> with <code>float</code> arguments then
this might happen:</p>

<figure class='code'><figcaption><span>prototype.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mi">5</span> <span class="o">+</span> <span class="mi">4</span> <span class="n">results</span> <span class="n">in</span> <span class="mi">2054324224</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that you know that the compiler (the real one) only needs the prototype and not the actual function code,
you may be wondering how the compiler actually compiles it if it doesn&rsquo;t know it&rsquo;s code.</p>

<p>Now is the time to bring down another missconception. The word <em>compiler</em> is just a fancy name for software
otherwise known as <em>translators</em>. A <em>translator&rsquo;s</em> job is to get input and turn it from one language (source language) to a second language (target language), whatever that may be. Most of the times, when you compile software,
you compile it to run in your computer, which runs on a processor from the x86 architecture family of processors.
A processor is typically associated with an assembly language for that architecture (which is just human friendly
mnemonics for common processor tasks), so your <em>x86 computer runs x86 assembly</em> (ok that&rsquo;s not 100% true, but for
simplicity&rsquo;s sake at the moment, it should serve. We will see why it&rsquo;s not true later.) So the compiler
(in a typical translation) translates (compiles) your C source code to x86 assembly.
You can see this by compiling your hello world example and passing the compiler the <code>-S</code> (which asks it to stop,
after x86 assembly is produced) parameter, likewise <code>gcc -S hello.c</code>.</p>

<h1>Conclusion</h1>

<p>At this part, we saw how the compiler and the preprocessor work with our code, in an attempt to demistify the
so called library calls. In the next part, we are going to study the assembler and the linker, and for the final
part the loader and the kernel.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GSOC Week 11 report]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/09/02/gsoc-week-11-report/"/>
    <updated>2013-09-02T09:25:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/09/02/gsoc-week-11-report</id>
    <content type="html"><![CDATA[<h1>Introduction</h1>

<p>This week was spent investigating the runtime and debugging executables with gdb.
It was interesting in the sense that it provided me with some interesting
pieces of information. Without any further ado, let&rsquo;s present our findings:</p>

<h2>My findings</h2>

<p>Before starting out playing with libpthread, and glibc, I wanted to make sure
that the goruntime behaved the way I believed it behaved, and make some further
assurances about the goruntime. These assurances had to do with the total number
of goroutines and the total number of machine threads at various checkpoints
in the language runtime.</p>

<ul>
<li>The first thread in the program is initialised during <code>runtime_schedinit</code>.</li>
<li>The number of m&rsquo;s (kernel threads) is dependent on the number of goroutines.
The runtime basically attempts to create an equal amount of m&rsquo;s to run the goroutines.
We can observe everytime a new goroutine is created, there is a number of calls
to initiate a new kernel thread.</li>
<li>There are at least two kernel threads. One that supports the runtime (mainly the
garbage collector) and one that executes the code of the go program.</li>
</ul>


<p>There is only one small piece of code in the goruntime that creates some sort of
confusion for me, and that is the code for a new m initialisation. Let me first
present the code that confuses me:</p>

<figure class='code'><figcaption><span>gcc/libgo/runtime/proc.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">M</span><span class="o">*</span>
</span><span class='line'><span class="nf">runtime_newm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>  <span class="n">mp</span> <span class="o">=</span> <span class="n">runtime_mal</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">mp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>  <span class="n">mcommoninit</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span><span class='line'>  <span class="n">mp</span><span class="o">-&gt;</span><span class="n">g0</span> <span class="o">=</span> <span class="n">runtime_malg</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nil</span><span class="p">,</span> <span class="n">nil</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">pthread_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="n">runtime_throw</span><span class="p">(</span><span class="s">&quot;pthread_attr_init&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">pthread_attr_setdetachstate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">PTHREAD_CREATE_DETACHED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="n">runtime_throw</span><span class="p">(</span><span class="s">&quot;pthread_attr_setdetachstate&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I purposely compacted the function for brevity, as it only serves as a demonstration for a point.
Now, my confusion lies in the line <code>mp-&gt;g0 = runtime_malg(-1, nil, nil)</code>. It is a piece of code
that allocates memory for a new goroutine. Now I am ok with that, <strong>but</strong> what I do not understand
is that new kernel threads (m&rsquo;s) are supposed to be pick and run a goroutine from the global
goroutine pool &ndash; that is run an existing one, and not create a new one. Now, the <code>runtime_malg</code>
is given parameters that don&rsquo;t initialise a new goroutine properly, but still, new memory
is allocated for a new goroutine, and is returned to <code>mp-&gt;g0</code> from runtime_malg.</p>

<p>Assuming I have not misunderstood something, and I am not mistaken (which is kind of likely),
this is behavior that could lead to a number of questions and/or problems. For instance,
what happens to the goroutine created by <code>runtime_malg</code>? Is it killed after the m is assigned
a new goroutine to execute? Is it parked on the goroutine global list? Is it just ignored?
Does it affect the runtime scheduler&rsquo;s goroutine count? This is the last thing I feel I wanna
clear out regarding gccgo&rsquo;s runtime.</p>

<h2>gdb</h2>

<p>For this week, I also run the executables created by gccgo through gdb. It was a fertile attempt
that, most of the time, confirmed my findings in the goruntime. It also provided us with some
other nice pieces of information regarding the crashing of goroutines, but also left me with a
question.</p>

<p>The code in question that I run through gdb is this:</p>

<figure class='code'><figcaption><span>goroutine.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">say</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;[!!] right before a go statement&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">go</span> <span class="nx">say</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">say</span> <span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Your very typical hello world like goroutine program. Now, setting a break point in main
(not the program&rsquo;s main, that&rsquo;s <code>main.main</code>. <code>main</code> as far as the runtime is concerned is
 the runtime entry point, in <code>go-main.c</code>) and running it through gdb yields the following
results:</p>

<figure class='code'><figcaption><span>goroutine.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">main</span> <span class="p">()</span> <span class="nx">at</span> <span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">gcc_source</span><span class="o">/</span><span class="nx">libgo</span><span class="o">/</span><span class="nx">runtime</span><span class="o">/</span><span class="k">go</span><span class="o">-</span><span class="nx">main</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">52</span>
</span><span class='line'><span class="mi">52</span> <span class="nx">runtime_check</span> <span class="p">();</span>
</span><span class='line'><span class="mi">2</span><span class="p">:</span>  <span class="nx">__pthread_total</span> <span class="p">=</span> <span class="mi">1</span>
</span><span class='line'><span class="mi">1</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">mcount</span> <span class="p">=</span> <span class="mi">0</span>
</span><span class='line'><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span> <span class="nx">next</span>
</span><span class='line'><span class="mi">53</span> <span class="nx">runtime_args</span> <span class="p">(</span><span class="nx">argc</span><span class="p">,</span> <span class="p">(</span><span class="kt">byte</span> <span class="o">**</span><span class="p">)</span> <span class="nx">argv</span><span class="p">);</span>
</span><span class='line'><span class="mi">2</span><span class="p">:</span> <span class="nx">__pthread_total</span> <span class="p">=</span> <span class="mi">1</span>
</span><span class='line'><span class="mi">1</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">mcount</span> <span class="p">=</span> <span class="mi">0</span>
</span><span class='line'><span class="mi">54</span> <span class="nx">runtime_osinit</span> <span class="p">();</span>
</span><span class='line'><span class="mi">2</span><span class="p">:</span> <span class="nx">__pthread_total</span> <span class="p">=</span> <span class="mi">1</span>
</span><span class='line'><span class="mi">1</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">mcount</span> <span class="p">=</span> <span class="mi">0</span>
</span><span class='line'><span class="mi">63</span><span class="p">:</span> <span class="nx">runtime_schedinit</span> <span class="p">();</span>
</span><span class='line'><span class="mi">2</span><span class="p">:</span> <span class="nx">__pthread_total</span> <span class="p">=</span> <span class="mi">1</span>
</span><span class='line'><span class="mi">1</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">mcount</span> <span class="p">=</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Up until now, nothing unexpected. The kernel thread is registered with the runtime scheduler
during its initialisation process in <code>runtime_schedinit</code> and that&#8217; why the <code>runtime_sched.mcount</code>
is reported to be zero many times before schedinit is run.</p>

<figure class='code'><figcaption><span>goroutine.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="mi">68</span> <span class="nx">__go_go</span> <span class="p">(</span><span class="nx">mainstart</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">);</span>
</span><span class='line'><span class="mi">2</span><span class="p">:</span> <span class="nx">__pthread_total</span> <span class="p">=</span> <span class="mi">1</span>
</span><span class='line'><span class="mi">1</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">mcount</span> <span class="p">=</span> <span class="mi">1</span>
</span><span class='line'><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span> <span class="nx">display</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">gcount</span>
</span><span class='line'><span class="mi">3</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">gcount</span> <span class="p">=</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>That too is ok, because a new goroutine is registered with the scheduler during the call to
<code>__go_go</code>. Now I am gonna fast forward a bit, to a more interesting point.</p>

<figure class='code'><figcaption><span>goroutine.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="p">[</span><span class="nx">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="nx">in</span> <span class="nx">runtime_gogo</span><span class="p">)</span> <span class="nx">new</span> <span class="nx">goroutine</span><span class="err">&#39;</span><span class="nx">s</span> <span class="nx">status</span> <span class="nx">is</span> <span class="mi">2</span>
</span><span class='line'><span class="p">[</span><span class="nx">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="nx">in</span> <span class="nx">runtime_gogo</span><span class="p">)</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">goroutines</span> <span class="nx">now</span> <span class="nx">is</span> <span class="mi">2</span>
</span><span class='line'><span class="p">[</span><span class="nx">New</span> <span class="nx">Thread</span> <span class="mf">629.30</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Program</span> <span class="nx">received</span> <span class="nx">SIGTRAP</span><span class="p">,</span> <span class="nx">Trace</span><span class="o">/</span><span class="nx">breakpoint</span> <span class="nx">trap</span><span class="p">.</span>
</span><span class='line'><span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'><span class="mi">3</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">gcount</span> <span class="p">=</span> <span class="mi">2</span>
</span><span class='line'><span class="mi">2</span><span class="p">:</span> <span class="nx">__pthread_total</span> <span class="p">=</span> <span class="mi">2</span>
</span><span class='line'><span class="mi">1</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">mcount</span> <span class="p">=</span> <span class="mi">2</span>
</span><span class='line'><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span> <span class="nx">info</span> <span class="nx">threads</span>
</span><span class='line'> <span class="nx">Id</span>   <span class="nx">Target</span>  <span class="nx">Id</span>       <span class="nx">Frame</span>
</span><span class='line'> <span class="mi">6</span>    <span class="nx">Thread</span>  <span class="mf">629.30</span>   <span class="mh">0x08048eb7</span> <span class="nx">in</span> <span class="nx">main</span><span class="p">.</span><span class="nx">main</span> <span class="p">()</span> <span class="nx">at</span> <span class="nx">goroutine</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">12</span>
</span><span class='line'> <span class="mi">5</span>    <span class="nx">Thread</span>  <span class="mf">629.29</span>   <span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'><span class="o">*</span><span class="mi">4</span>    <span class="nx">Thread</span>  <span class="mf">629.28</span>   <span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is getting weird. I mean, libpthread is reporting that 2 threads are active,
but gdb reports that 3 are active. Anyway, let&rsquo;s continue:</p>

<figure class='code'><figcaption><span>goroutine.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="p">[</span><span class="nx">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="nx">in</span> <span class="nx">runtime_stoptheworld</span><span class="p">)</span> <span class="nx">stopped</span> <span class="nx">the</span> <span class="nx">garbage</span> <span class="nx">collector</span>
</span><span class='line'><span class="p">[</span><span class="nx">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="nx">in</span> <span class="nx">runtime_starttheworld</span><span class="p">)</span> <span class="nx">starting</span> <span class="nx">the</span> <span class="nx">garbage</span> <span class="nx">collector</span>
</span><span class='line'><span class="p">[</span><span class="nx">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="nx">in</span> <span class="nx">runtime_starttheworld</span><span class="p">)</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">m</span><span class="err">&#39;</span><span class="nx">s</span> <span class="nx">now</span> <span class="nx">is</span><span class="p">:</span> <span class="mi">2</span>
</span><span class='line'><span class="p">[</span><span class="nx">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="nx">in</span> <span class="nx">runtime_starttheworld</span><span class="p">)</span> <span class="p">[</span><span class="nx">note</span><span class="p">]</span> <span class="nx">there</span> <span class="nx">is</span> <span class="nx">already</span> <span class="nx">one</span> <span class="nx">gc</span> <span class="nx">thread</span>
</span><span class='line'><span class="p">[!!]</span> <span class="nx">right</span> <span class="nx">before</span> <span class="nx">a</span> <span class="k">go</span> <span class="nx">statement</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Program</span> <span class="nx">received</span> <span class="nx">signal</span> <span class="nx">SIGTRAP</span><span class="p">,</span> <span class="nx">Trace</span><span class="o">/</span><span class="nx">breakpoint</span> <span class="nx">trap</span><span class="p">.</span>
</span><span class='line'><span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'><span class="mi">3</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">gcount</span> <span class="p">=</span> <span class="mi">2</span>
</span><span class='line'><span class="mi">2</span><span class="p">:</span> <span class="nx">__pthread_total</span> <span class="p">=</span> <span class="mi">2</span>
</span><span class='line'><span class="mi">1</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">mcount</span> <span class="p">=</span> <span class="mi">2</span>
</span><span class='line'><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span> <span class="k">continue</span>
</span><span class='line'><span class="o">...</span> <span class="p">(</span><span class="nx">output</span> <span class="nx">omitted</span> <span class="nx">by</span> <span class="nx">me</span> <span class="k">for</span> <span class="nx">brevity</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="nx">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="nx">in</span> <span class="nx">runtime_newm</span><span class="p">)</span> <span class="nx">Right</span> <span class="nx">before</span> <span class="nx">the</span> <span class="nx">call</span> <span class="nx">to</span> <span class="nx">pthread_create</span><span class="p">.</span>
</span><span class='line'><span class="nx">a</span><span class="p">.</span><span class="nx">out</span><span class="p">:</span> <span class="p">.</span><span class="o">/</span><span class="nx">pthread</span><span class="o">/</span><span class="nx">pt</span><span class="o">-</span><span class="nx">create</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">167</span><span class="p">:</span> <span class="nx">__pthread_create_internal</span><span class="p">:</span> <span class="nx">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="nx">mach_port_t</span> <span class="nx">ktid</span> <span class="p">=</span> <span class="nx">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">thread</span><span class="o">-</span><span class="p">&gt;</span><span class="nx">kernel_thread</span> <span class="o">==</span> <span class="nx">ktid</span><span class="p">;</span>
</span><span class='line'><span class="nx">__mach_port_deallocate</span> <span class="p">((</span><span class="nx">__mach_task_self</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">ktid</span><span class="p">);</span> <span class="nx">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="nx">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">[</span><span class="nx">New</span> <span class="nx">Thread</span> <span class="mf">629.31</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Program</span> <span class="nx">received</span> <span class="nx">signal</span> <span class="nx">SIGABRT</span><span class="p">,</span> <span class="nx">Aborted</span><span class="p">.</span>
</span><span class='line'><span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'><span class="mi">3</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">gcount</span> <span class="p">=</span> <span class="mi">3</span>
</span><span class='line'><span class="mi">2</span><span class="p">:</span> <span class="nx">__pthread_total</span> <span class="p">=</span> <span class="mi">2</span>
</span><span class='line'><span class="mi">1</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">mcount</span> <span class="p">=</span> <span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>


<p>Oh my goodness. From a first glance, this seems to be a very serious inconsistency between libpthread and the goruntime.
At this point, the go scheduler reports 3 threads (3 registered threads, that means
that flow of execution has passed <code>mcommoninit</code>, the kernel thread initialisation function
which also registers the kernel thread with the runtime_scheduler) whereas libpthread reports 2 threads.</p>

<p><strong>But WAIT! Where are you going? Things are about to get even more interesting!</strong></p>

<figure class='code'><figcaption><span>goroutine.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span> <span class="nx">info</span> <span class="nx">threads</span>
</span><span class='line'> <span class="nx">Id</span>   <span class="nx">Target</span>  <span class="nx">Id</span>       <span class="nx">Frame</span>
</span><span class='line'> <span class="mi">7</span>    <span class="nx">Thread</span>  <span class="mf">629.31</span>   <span class="mh">0x01f4da00</span> <span class="nx">in</span> <span class="nx">entry_point</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libpthread</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'> <span class="mi">6</span>    <span class="nx">Thread</span>  <span class="mf">629.30</span>   <span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'> <span class="mi">5</span>    <span class="nx">Thread</span>  <span class="mf">629.29</span>   <span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'><span class="o">*</span><span class="mi">4</span>    <span class="nx">Thread</span>  <span class="mf">629.28</span>   <span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span></code></pre></td></tr></table></div></figure>


<p>GDB reports 4 threads. Yes, 4 threads ladies and gentlemen. Now take a look closely.
3 threads are in the same frame, with the one with id 4 being the one currently executed.
And there is also a pattern. <code>0x01da48ec</code> is the value of the <code>eip</code> register for all 3 of them.</p>

<p>That&rsquo;s one thing that is for certain. Now I already have an idea. Why not change
the current thread to the one with id 7? I&rsquo;m sold to the idea, let&rsquo;s do this:</p>

<figure class='code'><figcaption><span>goroutine.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span> <span class="nx">thread</span> <span class="mi">7</span>
</span><span class='line'><span class="p">[</span><span class="nx">Switching</span> <span class="nx">to</span> <span class="nx">thread</span> <span class="mi">7</span> <span class="p">(</span><span class="nx">Thread</span> <span class="mf">629.31</span><span class="p">)]</span>
</span><span class='line'><span class="err">#</span><span class="mi">0</span>  <span class="mh">0x01f4da00</span> <span class="nx">in</span> <span class="nx">entry_point</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libpthread</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span> <span class="k">continue</span>
</span><span class='line'><span class="nx">Continuing</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Program</span> <span class="nx">received</span> <span class="nx">signal</span> <span class="nx">SIGABRT</span><span class="p">,</span> <span class="nx">Aborted</span><span class="p">.</span>
</span><span class='line'><span class="p">[</span><span class="nx">Switching</span> <span class="nx">to</span> <span class="nx">Thread</span> <span class="mf">629.28</span><span class="p">]</span>
</span><span class='line'><span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'><span class="mi">3</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">gcount</span> <span class="p">=</span> <span class="mi">3</span>
</span><span class='line'><span class="mi">2</span><span class="p">:</span> <span class="nx">__pthread_total</span> <span class="p">=</span> <span class="mi">2</span>
</span><span class='line'><span class="mi">1</span><span class="p">:</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">mcount</span> <span class="p">=</span> <span class="mi">3</span>
</span><span class='line'><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span> <span class="nx">info</span> <span class="nx">threads</span>
</span><span class='line'> <span class="nx">Id</span>   <span class="nx">Target</span>  <span class="nx">Id</span>       <span class="nx">Frame</span>
</span><span class='line'> <span class="mi">7</span>    <span class="nx">Thread</span>  <span class="mf">629.31</span>   <span class="mh">0x01dc08b0</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'> <span class="mi">6</span>    <span class="nx">Thread</span>  <span class="mf">629.30</span>   <span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'> <span class="mi">5</span>    <span class="nx">Thread</span>  <span class="mf">629.29</span>   <span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span><span class='line'><span class="o">*</span><span class="mi">4</span>    <span class="nx">Thread</span>  <span class="mf">629.28</span>   <span class="mh">0x01da48ec</span> <span class="nx">in</span> <span class="err">??</span> <span class="p">()</span> <span class="nx">from</span> <span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">i386</span><span class="o">-</span><span class="nx">gnu</span><span class="o">/</span><span class="nx">libc</span><span class="p">.</span><span class="nx">so</span><span class="mf">.0.3</span>
</span></code></pre></td></tr></table></div></figure>


<p>Damn. But I am curious. What&rsquo;s the next value to be executed?</p>

<figure class='code'><figcaption><span>goroutine.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span> <span class="nx">x</span><span class="o">/</span><span class="nx">i</span> <span class="err">$</span><span class="nx">eip</span>
</span><span class='line'><span class="p">=&gt;</span> <span class="mh">0x1da48ec</span><span class="p">:</span> <span class="nx">ret</span>
</span></code></pre></td></tr></table></div></figure>


<p>And what is the next value to be executed for the thread with id 7?</p>

<figure class='code'><figcaption><span>goroutine.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span> <span class="nx">x</span><span class="o">/</span><span class="nx">i</span> <span class="err">$</span><span class="nx">eip</span>
</span><span class='line'><span class="p">=&gt;</span> <span class="mh">0x1dc08b0</span><span class="p">:</span> <span class="nx">call</span> <span class="o">*%</span><span class="nx">edx</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Conclusion</h1>

<p>Apparently, there is still much debugging left to checkout what is really happening.
But we have got some leads in the right direction, that hopefully will lead us to
finally finding out where the problem lies, and correct it.</p>

<p>Most importantly, in my immediate plans, before iI start playing around with libpthread
is to attempt the same debugging run on the same code, under linux (x86). Seeing as
go is clean on linux, it would provide some clues as to what the expected results
should be, and where the execution differentiates substantially, a clue
that might be vital to finding the problem.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GSOC week 10 report]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/08/26/gsoc-week-10-report/"/>
    <updated>2013-08-26T09:00:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/08/26/gsoc-week-10-report</id>
    <content type="html"><![CDATA[<h1>Introduction</h1>

<p>This week was spent attempting to debug the gccgo runtime via print statements. There were many things
that I gained from this endeavour. The most significant of which, is the fact that I have got a great
deal of information regarding the bootstrapping of a go process. Let&rsquo;s proceed into presenting this
week&rsquo;s findings, shall we?</p>

<h1>Findings</h1>

<h2>The process bootstrapping sequence</h2>

<p>The code that begins a new go-process is conveniently located in a file called <code>go-main.c</code>, the most significant
part of which is the following:</p>

<figure class='code'><figcaption><span>go-main.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">runtime_check</span> <span class="p">();</span>
</span><span class='line'>  <span class="n">runtime_args</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">**</span><span class="p">)</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'>  <span class="n">runtime_osinit</span> <span class="p">();</span>
</span><span class='line'>  <span class="n">runtime_schedinit</span> <span class="p">();</span>
</span><span class='line'>  <span class="n">__go_go</span> <span class="p">(</span><span class="n">mainstart</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>  <span class="n">runtime_mstart</span> <span class="p">(</span><span class="n">runtime_m</span> <span class="p">());</span>
</span><span class='line'>  <span class="n">abort</span> <span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span>
</span><span class='line'><span class="nf">mainstart</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">unused</span><span class="p">)))</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">runtime_main</span> <span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The process is as follows:</p>

<ul>
<li>First <code>runtime_check</code> runs and registers the os_Args and syscall_Envs as runtime_roots with the garbage collector. I am still investigating what this function exactly is doing, but it seems like some early initialisation of the garbage collector</li>
<li>Secondly, <code>runtime_args</code> is run. It&rsquo;s job is to call a specific argument handler for the arguments passed to <code>main</code>.</li>
<li>Thirdly, <code>runtime_osinit</code> is run, whose job is to call the lowlevel _CPU_COUNT function, to get the number of CPUs (in a specific data structure that represents a set of CPUs)</li>
<li>After that, <code>runtime_schedinit</code> is run, whose job is to create the very first goroutine (g) and system thread (m), and continues with parsing the command line arguments, and the environment variables. After that it sets the maximum number of cpus that are to be used (via <code>GOMAXPROCS</code>), runs the first goroutine, and does some last pieces of the scheduler&rsquo;s initialisation.</li>
<li>Following <code>runtime_schedinit</code>, <code>__go_go</code> is run, a function whose purpose is to create a new queue, tell it to execute the function that is passed to it as the first parameter, and then queue the goroutine in the
global ready-to-run goroutine pool.</li>
<li>Last but not least, <code>runtime_mstart</code> runs, which seems to be starting te execution of the kernel thread created during <code>runtime_schedinit</code>.</li>
</ul>


<p>The very last piece of code that is run (and most probably the most important) is <code>runtime_main</code>. Remember that this is passed as a parameter to a goroutine created during the <code>__go_go</code> call, and its job is to mark the goroutine that called it as <em>the main os thread</em>, to initialise the sceduler, and create a goroutine whose job is to release unused memory (from the heap) back to the OS.
It then starts executing the process user defined instructions (the code the programmer run) via a call to a
macro that directs it to <code>__go_init_main</code> in the assembly generated by the compiler.</p>

<p><code>Runtime_main</code> is also the function that terminates the execution of a go process, with a call to <code>runtime_exit</code>
which seems to be a macro to the <code>exit</code> function.</p>

<h2>Other findings</h2>

<p>During our debugging sessions we found out that the total count of kernel threads that are running in a simple program is at least two.
The first one is the bootstrap M, (the one initialised during the program&rsquo;s initialisation, inside <code>runtime_schedinit</code>) and at least another one, (I am still invistigating the validity of the following claim)
created to be used by the garbage collector.</p>

<p>A simple go program such as one doing arithmetic or printing a helloworld like message evidently has no issue
running.
The issues arrise when we use a <code>go statement</code>. With all our debugging messages activated, this is how a simple
go program flows:</p>

<figure class='code'><figcaption><span>go-main.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">root</span><span class="err">@</span><span class="n">debian</span><span class="o">:~/</span><span class="n">Software</span><span class="o">/</span><span class="n">Experiments</span><span class="o">/</span><span class="n">go</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">main</span><span class="p">)</span> <span class="n">before</span> <span class="n">runtime_mcheck</span> <span class="n">is</span> <span class="n">run</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">main</span><span class="p">)</span> <span class="n">before</span> <span class="n">runtime_args</span> <span class="n">is</span> <span class="n">run</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">main</span><span class="p">)</span> <span class="n">before</span> <span class="n">runtime_osinit</span> <span class="n">is</span> <span class="n">run</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">main</span><span class="p">)</span> <span class="n">before</span> <span class="n">runtime_schedinit</span> <span class="n">is</span> <span class="n">run</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">main</span><span class="p">)</span> <span class="n">before</span> <span class="n">runtime_mstart</span> <span class="n">is</span> <span class="n">run</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_mstart</span><span class="p">)</span> <span class="n">right</span> <span class="n">before</span> <span class="n">the</span> <span class="n">call</span> <span class="n">to</span> <span class="n">runtime_minit</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">mainstart</span><span class="p">)</span> <span class="n">right</span> <span class="n">before</span> <span class="n">the</span> <span class="n">call</span> <span class="n">to</span> <span class="n">runtime_main</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_main</span><span class="p">)</span> <span class="n">Beginning</span> <span class="n">of</span> <span class="n">runtime_main</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">start</span> <span class="n">of</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">m</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">is</span> <span class="mi">1</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">Preparing</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="n">new</span> <span class="kr">thread</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">Right</span> <span class="n">before</span> <span class="n">the</span> <span class="n">call</span> <span class="n">to</span> <span class="n">pthread_create</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">pthread_create</span> <span class="n">returned</span> <span class="mi">0</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_mstart</span><span class="p">)</span> <span class="n">right</span> <span class="n">before</span> <span class="n">the</span> <span class="n">call</span> <span class="n">to</span> <span class="n">runtime_minit</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">end</span> <span class="n">of</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">m</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">is</span> <span class="mi">2</span>
</span><span class='line'><span class="n">Hello</span><span class="p">,</span> <span class="n">fotis</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_main</span><span class="p">)</span> <span class="n">Right</span> <span class="n">before</span> <span class="n">runtime_exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>And this is how a goroutine powered program fails:</p>

<figure class='code'><figcaption><span>go-main.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">root</span><span class="err">@</span><span class="n">debian</span><span class="o">:~/</span><span class="n">Software</span><span class="o">/</span><span class="n">Experiments</span><span class="o">/</span><span class="n">go</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">main</span><span class="p">)</span> <span class="n">before</span> <span class="n">runtime_mcheck</span> <span class="n">is</span> <span class="n">run</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">main</span><span class="p">)</span> <span class="n">before</span> <span class="n">runtime_args</span> <span class="n">is</span> <span class="n">run</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">main</span><span class="p">)</span> <span class="n">before</span> <span class="n">runtime_osinit</span> <span class="n">is</span> <span class="n">run</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">main</span><span class="p">)</span> <span class="n">before</span> <span class="n">runtime_schedinit</span> <span class="n">is</span> <span class="n">run</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">main</span><span class="p">)</span> <span class="n">before</span> <span class="n">runtime_mstart</span> <span class="n">is</span> <span class="n">run</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_mstart</span><span class="p">)</span> <span class="n">right</span> <span class="n">before</span> <span class="n">the</span> <span class="n">call</span> <span class="n">to</span> <span class="n">runtime_minit</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">mainstart</span><span class="p">)</span> <span class="n">right</span> <span class="n">before</span> <span class="n">the</span> <span class="n">call</span> <span class="n">to</span> <span class="n">runtime_main</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_main</span><span class="p">)</span> <span class="n">Beginning</span> <span class="n">of</span> <span class="n">runtime_main</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">start</span> <span class="n">of</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">m</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">is</span> <span class="mi">1</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">Preparing</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="n">new</span> <span class="kr">thread</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">Right</span> <span class="n">before</span> <span class="n">the</span> <span class="n">call</span> <span class="n">to</span> <span class="n">pthread_create</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">pthread_create</span> <span class="n">returned</span> <span class="mi">0</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_mstart</span><span class="p">)</span> <span class="n">right</span> <span class="n">before</span> <span class="n">the</span> <span class="n">call</span> <span class="n">to</span> <span class="n">runtime_minit</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">end</span> <span class="n">of</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">m</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">is</span> <span class="mi">2</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">start</span> <span class="n">of</span> <span class="n">runtime_new</span><span class="p">)</span> <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">m</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">is</span> <span class="mi">2</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">Preparing</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="n">new</span> <span class="kr">thread</span><span class="p">.</span>
</span><span class='line'><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">(</span><span class="n">in</span> <span class="n">runtime_newm</span><span class="p">)</span> <span class="n">Right</span> <span class="n">before</span> <span class="n">the</span> <span class="n">call</span> <span class="n">to</span> <span class="n">pthread_create</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span>
</span><span class='line'><span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="n">Aborted</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Work for the next week</h1>

<p>I will of course continue to print debug until I have knowledge of the exact flow of execution in the go
runtime. Right now I have very good knowledge of the flow, but there are some things that I need to sort out.
For instance it is not exactly clear to me why we call certain functions, or what they are supposed to be doing at certain parts. After I sort this out,  I also plan to start debugging the libpthread to see what&rsquo;s libpthreads status
during a hello world like program, and during a goroutine powered program, to get to see if we get
to find something interesting in libpthread (like how many threads does libpthread report against how
many the goruntime reports)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GSOC Week 9 (Partial) report]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/08/19/gsoc-week-9-partial-report/"/>
    <updated>2013-08-19T11:35:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/08/19/gsoc-week-9-partial-report</id>
    <content type="html"><![CDATA[<p>This week was revolving around the print debugging in the gccgo runtime in search
for clues regarding the creation of new threads under the goruntime, so as to see
if there is something wrong with the runtime itself, or the way the runtime
interacts with the libpthread.</p>

<h2>(partial presentation of) findings</h2>

<p>During print debugging the gccgo runtime, I didn&rsquo;t notice anything abnormal or
unusual so far. For example, the code that does trigger the assertion failure
seems to work at least once, since <code>pthread_create()</code> returns <code>0</code> at least once.</p>

<p>This is expected behavior, since we already have stated that there is at least
one <code>M</code> (kernel thread) created at the initialisation of the program&rsquo;s runtime.</p>

<p>If however, we try to use a <em>go statement</em> in our program, to make usage of a
goroutine, the runtime still fails at the usual assertion fail, however the
output of the program is this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@debian:~/Software/Experiments/go# ./a.out
</span><span class='line'>[DEBUG] pthread_create returned 0
</span><span class='line'>a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid;
</span><span class='line'>__mach_port_deallocate ((__mach_task_self + 0), ktid); ok; })' failed.
</span><span class='line'>Aborted</span></code></pre></td></tr></table></div></figure>


<p>The above output can give us some pieces of information:</p>

<ul>
<li><code>pthread_create()</code> is called at least once.</li>
<li>it executes successfuly and without errors &ndash; libpthread code suggests that 0 is returned upon successful execution and creation of a thread</li>
<li>However the assertion is still triggered, which we know it&rsquo;s getting triggered during thread creation.</li>
</ul>


<p>The second bullet point is also being supported by the fact that even if you exe
cute something as simple as hello world in go, a new M is created, so you get
something along the lines of this as an output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@debian:~/Software/Experiments/go# ./a.out
</span><span class='line'>[DEBUG] pthread_create returned 0
</span><span class='line'>Hello World!
</span><span class='line'>root@debian:~/Software/Experiments/go#</span></code></pre></td></tr></table></div></figure>


<p>There is however something that the above piece of code doesn&rsquo;t tell us,
but it would be useful to know: <em>How many times did we create a new thread?</em>
So we modify our gcc&rsquo;s source code to see how many times the runtimes
attempts to create a new kernel thread (M). This is what we get out of it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@debian:~/Software/Experiments/go# ./a.out
</span><span class='line'>[DEBUG] Preparing to create a new thread.
</span><span class='line'>[DEBUG] pthread_create returned 0
</span><span class='line'>a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid;
</span><span class='line'>__mach_port_deallocate ((__mach_task_self + 0), ktid); ok; })' failed.
</span><span class='line'>[DEBUG] Preparing to create a new thread.
</span><span class='line'>aborted.</span></code></pre></td></tr></table></div></figure>


<p>The code at this point in the runtime is this:</p>

<figure class='code'><figcaption><span>proc.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// Create a new m.  It will start off with a call to runtime_mstart.</span>
</span><span class='line'><span class="n">M</span><span class="o">*</span>
</span><span class='line'><span class="nf">runtime_newm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">M</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
</span><span class='line'>  <span class="n">pthread_attr_t</span> <span class="n">attr</span><span class="p">;</span>
</span><span class='line'>  <span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">size_t</span> <span class="n">stacksize</span><span class="p">;</span>
</span><span class='line'>  <span class="n">sigset_t</span> <span class="n">clear</span><span class="p">;</span>
</span><span class='line'>  <span class="n">sigset_t</span> <span class="n">old</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if 0</span><span class="c"></span>
</span><span class='line'><span class="c">  static const Type *mtype;  // The Go type M</span>
</span><span class='line'><span class="c">  if(mtype == nil) {</span>
</span><span class='line'><span class="c">      Eface e;</span>
</span><span class='line'><span class="c">      runtime_gc_m_ptr(&amp;e);</span>
</span><span class='line'><span class="c">      mtype = ((const PtrType*)e.__type_descriptor)-&gt;__element_type;</span>
</span><span class='line'><span class="c">  }</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// XXX: Added by fotis for print debugging.</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[DEBUG] Preparing to create a new thread.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mp</span> <span class="o">=</span> <span class="n">runtime_mal</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">mp</span><span class="p">);</span>
</span><span class='line'>  <span class="n">mcommoninit</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span><span class='line'>  <span class="n">mp</span><span class="o">-&gt;</span><span class="n">g0</span> <span class="o">=</span> <span class="n">runtime_malg</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nil</span><span class="p">,</span> <span class="n">nil</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">pthread_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="n">runtime_throw</span><span class="p">(</span><span class="s">&quot;pthread_attr_init&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">pthread_attr_setdetachstate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">PTHREAD_CREATE_DETACHED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="n">runtime_throw</span><span class="p">(</span><span class="s">&quot;pthread_attr_setdetachstate&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// &lt;http://www.gnu.org/software/hurd/open_issues/libpthread_set_stack_size.html&gt;</span>
</span><span class='line'><span class="cp">#ifdef __GNU__</span>
</span><span class='line'>  <span class="n">stacksize</span> <span class="o">=</span> <span class="n">StackMin</span><span class="p">;</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="n">stacksize</span> <span class="o">=</span> <span class="n">PTHREAD_STACK_MIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// With glibc before version 2.16 the static TLS size is taken</span>
</span><span class='line'>  <span class="c1">// out of the stack size, and we get an error or a crash if</span>
</span><span class='line'>  <span class="c1">// there is not enough stack space left.  Add it back in if we</span>
</span><span class='line'>  <span class="c1">// can, in case the program uses a lot of TLS space.  FIXME:</span>
</span><span class='line'>  <span class="c1">// This can be disabled in glibc 2.16 and later, if the bug is</span>
</span><span class='line'>  <span class="c1">// indeed fixed then.</span>
</span><span class='line'>  <span class="n">stacksize</span> <span class="o">+=</span> <span class="n">tlssize</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">pthread_attr_setstacksize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">stacksize</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="n">runtime_throw</span><span class="p">(</span><span class="s">&quot;pthread_attr_setstacksize&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Block signals during pthread_create so that the new thread</span>
</span><span class='line'>  <span class="c1">// starts with signals disabled.  It will enable them in minit.</span>
</span><span class='line'>  <span class="n">sigfillset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clear</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef SIGTRAP</span>
</span><span class='line'>  <span class="c1">// Blocking SIGTRAP reportedly breaks gdb on Alpha GNU/Linux.</span>
</span><span class='line'>  <span class="n">sigdelset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clear</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old</span><span class="p">);</span>
</span><span class='line'>  <span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_BLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clear</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old</span><span class="p">);</span>
</span><span class='line'>  <span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">runtime_mstart</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* XXX: added for debug printing */</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[DEBUG] pthread_create() returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old</span><span class="p">,</span> <span class="n">nil</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="n">runtime_throw</span><span class="p">(</span><span class="s">&quot;pthread_create&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can deduce two things about our situation right now:</p>

<ul>
<li>There is <strong>at least one</strong> thread successfully created, and there is an attempt
to create another one.</li>
<li>The second time, there is a failure before pthread_create is called.</li>
</ul>


<h2>Continuation of work.</h2>

<p>I have been following this course of path the last week. I presented
some of my findings, and hope to soon be able to write an exhaustive
report on what exactly it is that causes the bug.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GSOC Week 8 (Partial) report]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/08/12/gsoc-week-8-partial-report/"/>
    <updated>2013-08-12T10:27:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/08/12/gsoc-week-8-partial-report</id>
    <content type="html"><![CDATA[<p>This week was spent studying the go language&rsquo;s runtime and studying the behaviour of various go programs when executed under the Hurd. I learnt a variety of new things, and got some
new clues about the problem.</p>

<h2>The new libgo clues</h2>

<p>I already know that <em>M&rsquo;s are the &ldquo;real&rdquo; kernel schedulable threads</em> and <em>G&rsquo;s are the go runtime managed ones (goroutines)</em>. Last time I had gone through the go runtime&rsquo;s code I had noticed that neither of them get created, so there must be an issue with thread creation. <strong>But since there is at least one of each created during the program&rsquo;s initialization, how come
most programs are able to run, and issues present themselves when we manually attempt to run a goroutine?</strong></p>

<p>I will admit that the situation looks strange. So I decided to look more into it. Before we go any further, I have to embed the issues I had when I run goroutine powered programs under the Hurd.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@debian:~/Software/Experiments/go# ./a.out
</span><span class='line'>a.out: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid;
</span><span class='line'>__mach_port_deallocate ((__mach_task_self + 0), ktid); ok; })' failed.
</span><span class='line'>Aborted</span></code></pre></td></tr></table></div></figure>


<p><code>__pthread_create_internal</code> is a libpthread function that gets called when a new posix thread is instanciated. So we know that when we call a goroutine, apart from the goroutine,
there is at least one kernel thread created, otherwise, if a new goroutine was created, and not a new kernel thread (M) why wasn&rsquo;t it matched with an existing kernel thread
(remember there is at least one).</p>

<p>That made me look into the go runtime some more. I found a lot of things, that I can not enumerate here, but amongst the most interesting ones, was the following piece of code:</p>

<figure class='code'><figcaption><span>proc.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="c1">// Create a new m.  It will start off with a call to runtime_mstart.</span>
</span><span class='line'><span class="nx">M</span><span class="o">*</span>
</span><span class='line'><span class="nx">runtime_newm</span><span class="p">(</span><span class="nx">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">M</span> <span class="o">*</span><span class="nx">mp</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">pthread_attr_t</span> <span class="nx">attr</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">pthread_t</span> <span class="nx">tid</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">size_t</span> <span class="nx">stacksize</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">sigset_t</span> <span class="nx">clear</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">sigset_t</span> <span class="nx">old</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="nx">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="err">#</span><span class="k">if</span> <span class="mi">0</span>
</span><span class='line'>  <span class="nx">static</span> <span class="kd">const</span> <span class="nx">Type</span> <span class="o">*</span><span class="nx">mtype</span><span class="p">;</span>  <span class="c1">// The Go type M</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">mtype</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">Eface</span> <span class="nx">e</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">runtime_gc_m_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">e</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">mtype</span> <span class="p">=</span> <span class="p">((</span><span class="kd">const</span> <span class="nx">PtrType</span><span class="o">*</span><span class="p">)</span><span class="nx">e</span><span class="p">.</span><span class="nx">__type_descriptor</span><span class="p">)</span><span class="o">-</span><span class="p">&gt;</span><span class="nx">__element_type</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="err">#</span><span class="nx">endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">mp</span> <span class="p">=</span> <span class="nx">runtime_mal</span><span class="p">(</span><span class="nx">sizeof</span> <span class="o">*</span><span class="nx">mp</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">mcommoninit</span><span class="p">(</span><span class="nx">mp</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">mp</span><span class="o">-</span><span class="p">&gt;</span><span class="nx">g0</span> <span class="p">=</span> <span class="nx">runtime_malg</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">pthread_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">runtime_throw</span><span class="p">(</span><span class="s">&quot;pthread_attr_init&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">pthread_attr_setdetachstate</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">PTHREAD_CREATE_DETACHED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">runtime_throw</span><span class="p">(</span><span class="s">&quot;pthread_attr_setdetachstate&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">stacksize</span> <span class="p">=</span> <span class="nx">PTHREAD_STACK_MIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// With glibc before version 2.16 the static TLS size is taken</span>
</span><span class='line'>  <span class="c1">// out of the stack size, and we get an error or a crash if</span>
</span><span class='line'>  <span class="c1">// there is not enough stack space left.  Add it back in if we</span>
</span><span class='line'>  <span class="c1">// can, in case the program uses a lot of TLS space.  FIXME:</span>
</span><span class='line'>  <span class="c1">// This can be disabled in glibc 2.16 and later, if the bug is</span>
</span><span class='line'>  <span class="c1">// indeed fixed then.</span>
</span><span class='line'>  <span class="nx">stacksize</span> <span class="o">+=</span> <span class="nx">tlssize</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">pthread_attr_setstacksize</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">stacksize</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">runtime_throw</span><span class="p">(</span><span class="s">&quot;pthread_attr_setstacksize&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Block signals during pthread_create so that the new thread</span>
</span><span class='line'>  <span class="c1">// starts with signals disabled.  It will enable them in minit.</span>
</span><span class='line'>  <span class="nx">sigfillset</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">clear</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="err">#</span><span class="nx">ifdef</span> <span class="nx">SIGTRAP</span>
</span><span class='line'>  <span class="c1">// Blocking SIGTRAP reportedly breaks gdb on Alpha GNU/Linux.</span>
</span><span class='line'>  <span class="nx">sigdelset</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">clear</span><span class="p">,</span> <span class="nx">SIGTRAP</span><span class="p">);</span>
</span><span class='line'><span class="err">#</span><span class="nx">endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">old</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">sigprocmask</span><span class="p">(</span><span class="nx">SIG_BLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">clear</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">old</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">ret</span> <span class="p">=</span> <span class="nx">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">tid</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">runtime_mstart</span><span class="p">,</span> <span class="nx">mp</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">sigprocmask</span><span class="p">(</span><span class="nx">SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">old</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">runtime_throw</span><span class="p">(</span><span class="s">&quot;pthread_create&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">mp</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the code that creates a new kernel thread. Notice the line <code>ret = pthread_create(&amp;tid, &amp;attr, runtime_mstart, mp);</code>. It&rsquo;s obvious that it creates a new kernel thread,
so that explains why we get the specific error. But what is not explained is that since we do have at least one in program startup, why is this specific error only triggered when
we manually create a go routine?</p>

<h2>Go programs under the Hurd</h2>

<p>Apart from studying Go&rsquo;s runtime source code, I also run some experiments under the Hurd. I got some very weird results that I am investigating, but I would like to share nonetheless.
Consider the following piece of code:</p>

<figure class='code'><figcaption><span>hellogoroutines.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">say</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">say</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">say</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A very basic example that can demonstrate goroutines. Now, if we change <strong>one</strong> of the say functions inside main to a goroutine, this happens:</p>

<figure class='code'><figcaption><span>hellogoroutines.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">root</span><span class="err">@</span><span class="nx">debian</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">Software</span><span class="o">/</span><span class="nx">Experiments</span><span class="o">/</span><span class="k">go</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="nx">a</span><span class="p">.</span><span class="nx">out</span>
</span><span class='line'><span class="nx">a</span><span class="p">.</span><span class="nx">out</span><span class="p">:</span> <span class="p">.</span><span class="o">/</span><span class="nx">pthread</span><span class="o">/</span><span class="nx">pt</span><span class="o">-</span><span class="nx">create</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">167</span><span class="p">:</span> <span class="nx">__pthread_create_internal</span><span class="p">:</span> <span class="nx">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="nx">mach_port_t</span> <span class="nx">ktid</span> <span class="p">=</span> <span class="nx">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">thread</span><span class="o">-</span><span class="p">&gt;</span><span class="nx">kernel_thread</span> <span class="o">==</span> <span class="nx">ktid</span><span class="p">;</span>
</span><span class='line'><span class="nx">__mach_port_deallocate</span> <span class="p">((</span><span class="nx">__mach_task_self</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">ktid</span><span class="p">);</span> <span class="nx">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="nx">failed</span><span class="p">.</span>
</span><span class='line'><span class="nx">Aborted</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>BUT</strong> if we change <strong>BOTH</strong> of these functions to goroutines (<code>go say("world")</code>, <code>go say("hello")</code>), this happens:</p>

<figure class='code'><figcaption><span>hellogoroutines.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">root</span><span class="err">@</span><span class="nx">debian</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">Software</span><span class="o">/</span><span class="nx">Experiments</span><span class="o">/</span><span class="k">go</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="nx">a</span><span class="p">.</span><span class="nx">out</span>
</span><span class='line'><span class="nx">root</span><span class="err">@</span><span class="nx">debian</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">Software</span><span class="o">/</span><span class="nx">Experiments</span><span class="o">/</span><span class="k">go</span><span class="err">#</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wait a minute. It can&rsquo;t be! Did it execute correctly? Where is the output?</p>

<figure class='code'><figcaption><span>hellogoroutines.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">root</span><span class="err">@</span><span class="nx">debian</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">Software</span><span class="o">/</span><span class="nx">Experiments</span><span class="o">/</span><span class="k">go</span><span class="err">#</span> <span class="nx">echo</span> <span class="err">$?</span>
</span><span class='line'><span class="mi">0</span>
</span><span class='line'><span class="nx">root</span><span class="err">@</span><span class="nx">debian</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">Software</span><span class="o">/</span><span class="nx">Experiments</span><span class="o">/</span><span class="k">go</span><span class="err">#</span>
</span></code></pre></td></tr></table></div></figure>


<p>It reports that it has executed correctly. But there is no output.</p>

<h2>What I am doing next</h2>

<p>I will continue reading through the go runtime for some clues. On the more active size, I am writing a custom test case for goroutine testing under the Hurd, while also doing some analysis
on the programs that run there (currently studying the assembly generated for these programs) to see how they differ and why we get this particular behavior.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GSOC (Partial) Week 7 report]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/08/05/gsoc-partial-week-7-report/"/>
    <updated>2013-08-05T01:36:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/08/05/gsoc-partial-week-7-report</id>
    <content type="html"><![CDATA[<h1>An exciting week.</h1>

<p>This week was exciting. Spending it on learning about the go runtime was the reason for this. As insightfull as it was however,
it also confused me a little bit. Before this goes any further, I should state that this is a partial report on my research
and my findings. My aims for this week were the following: <strong>To investigate the behavior of go programs under the Hurd, to
study the go runtime, and possibly modify it to see if the goroutine issues are libpthread&rsquo;s issue or the go&rsquo;s runtime issue</strong>.</p>

<h1>Presenting my findings.</h1>

<p>Most of my time was spent studying the gcc go frontend, libgo and the go runtime. Fortunatelly, I can say (gladly) that it was
time well spent. What I got from it were some nice pieces of insight, but also some slight confusion and doubts.</p>

<p>The first interesting thing in my findings was this:</p>

<figure class='code'><figcaption><span>runtime.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">struct</span> <span class="nx">G</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">Defer</span><span class="o">*</span>   <span class="k">defer</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">Panic</span><span class="o">*</span>   <span class="nx">panic</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">void</span><span class="o">*</span>    <span class="nx">exception</span><span class="p">;</span>   <span class="c1">// current exception being thrown</span>
</span><span class='line'>  <span class="kt">bool</span>    <span class="nx">is_foreign</span><span class="p">;</span>  <span class="c1">// whether current exception from other language</span>
</span><span class='line'>  <span class="nx">void</span>    <span class="o">*</span><span class="nx">gcstack</span><span class="p">;</span> <span class="c1">// if status==Gsyscall, gcstack = stackbase to use during gc</span>
</span><span class='line'>  <span class="kt">uintptr</span> <span class="nx">gcstack_size</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">void</span><span class="o">*</span>    <span class="nx">gcnext_segment</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">void</span><span class="o">*</span>    <span class="nx">gcnext_sp</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">void</span><span class="o">*</span>    <span class="nx">gcinitial_sp</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">ucontext_t</span> <span class="nx">gcregs</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">byte</span><span class="o">*</span>    <span class="nx">entry</span><span class="p">;</span>       <span class="c1">// initial function</span>
</span><span class='line'>  <span class="nx">G</span><span class="o">*</span>   <span class="nx">alllink</span><span class="p">;</span> <span class="c1">// on allg</span>
</span><span class='line'>  <span class="nx">void</span><span class="o">*</span>    <span class="nx">param</span><span class="p">;</span>       <span class="c1">// passed parameter on wakeup</span>
</span><span class='line'>  <span class="kt">bool</span>    <span class="nx">fromgogo</span><span class="p">;</span>    <span class="c1">// reached from gogo</span>
</span><span class='line'>  <span class="kt">int16</span>   <span class="nx">status</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int64</span>   <span class="nx">goid</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">uint32</span>  <span class="nx">selgen</span><span class="p">;</span>      <span class="c1">// valid sudog pointer</span>
</span><span class='line'>  <span class="kd">const</span> <span class="nx">char</span><span class="o">*</span>  <span class="nx">waitreason</span><span class="p">;</span>  <span class="c1">// if status==Gwaiting</span>
</span><span class='line'>  <span class="nx">G</span><span class="o">*</span>   <span class="nx">schedlink</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">bool</span>    <span class="nx">readyonstop</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">bool</span>    <span class="nx">ispanic</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">bool</span>    <span class="nx">issystem</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int8</span>    <span class="nx">raceignore</span><span class="p">;</span> <span class="c1">// ignore race detection events</span>
</span><span class='line'>  <span class="nx">M</span><span class="o">*</span>   <span class="nx">m</span><span class="p">;</span>       <span class="c1">// for debuggers, but offset not hard-coded</span>
</span><span class='line'>  <span class="nx">M</span><span class="o">*</span>   <span class="nx">lockedm</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">M</span><span class="o">*</span>   <span class="nx">idlem</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">sig</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">writenbuf</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">byte</span><span class="o">*</span>    <span class="nx">writebuf</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// DeferChunk  *dchunk;</span>
</span><span class='line'>  <span class="c1">// DeferChunk  *dchunknext;</span>
</span><span class='line'>  <span class="kt">uintptr</span> <span class="nx">sigcode0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">uintptr</span> <span class="nx">sigcode1</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// uintptr sigpc;</span>
</span><span class='line'>  <span class="kt">uintptr</span> <span class="nx">gopc</span><span class="p">;</span>    <span class="c1">// pc of go statement that created this goroutine</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">ncgo</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">CgoMal</span><span class="o">*</span>  <span class="nx">cgomal</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">Traceback</span><span class="o">*</span> <span class="nx">traceback</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">ucontext_t</span>  <span class="nx">context</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">void</span><span class="o">*</span>        <span class="nx">stack_context</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yep. This is the code that resembles a (yeah, you guessed it, a <strong>goroutine</strong>). I was pretty surprised at first to see that a thread is resembled as a struct. But then again,
taking a closer look at it, it makes perfect sense. The next one though was a <em>lot trickier</em>:</p>

<figure class='code'><figcaption><span>runtime.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">struct</span> <span class="nx">M</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">G</span><span class="o">*</span>   <span class="nx">g0</span><span class="p">;</span>      <span class="c1">// goroutine with scheduling stack</span>
</span><span class='line'>  <span class="nx">G</span><span class="o">*</span>   <span class="nx">gsignal</span><span class="p">;</span> <span class="c1">// signal-handling G</span>
</span><span class='line'>  <span class="nx">G</span><span class="o">*</span>   <span class="nx">curg</span><span class="p">;</span>        <span class="c1">// current running goroutine</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">id</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">mallocing</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">throwing</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">gcing</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">locks</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">nomemprof</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">waitnextg</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">dying</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">profilehz</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span>   <span class="nx">helpgc</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">uint32</span>  <span class="nx">fastrand</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">uint64</span>  <span class="nx">ncgocall</span><span class="p">;</span>    <span class="c1">// number of cgo calls in total</span>
</span><span class='line'>  <span class="nx">Note</span>    <span class="nx">havenextg</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">G</span><span class="o">*</span>   <span class="nx">nextg</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">M</span><span class="o">*</span>   <span class="nx">alllink</span><span class="p">;</span> <span class="c1">// on allm</span>
</span><span class='line'>  <span class="nx">M</span><span class="o">*</span>   <span class="nx">schedlink</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">MCache</span>  <span class="o">*</span><span class="nx">mcache</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">G</span><span class="o">*</span>   <span class="nx">lockedg</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">G</span><span class="o">*</span>   <span class="nx">idleg</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">Location</span> <span class="nx">createstack</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span> <span class="c1">// Stack that created this thread.</span>
</span><span class='line'>  <span class="nx">M</span><span class="o">*</span>   <span class="nx">nextwaitm</span><span class="p">;</span>   <span class="c1">// next M waiting for lock</span>
</span><span class='line'>  <span class="kt">uintptr</span> <span class="nx">waitsema</span><span class="p">;</span>    <span class="c1">// semaphore for parking on locks</span>
</span><span class='line'>  <span class="kt">uint32</span>  <span class="nx">waitsemacount</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">uint32</span>  <span class="nx">waitsemalock</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">GCStats</span> <span class="nx">gcstats</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">bool</span>    <span class="nx">racecall</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">void</span><span class="o">*</span>    <span class="nx">racepc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">uintptr</span> <span class="nx">settype_buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">uintptr</span> <span class="nx">settype_bufsize</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">uintptr</span> <span class="nx">end</span><span class="p">[];</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>This was a source of endless confusion at the beginning. It does have some hints reassuring the fact that G&rsquo;s are indeed goroutines, but nothing that really helps to describe what an M is.
It&rsquo;s structure is identical to that of the G however, which means that it might have something to do with a thread. And indeed it is. Further study of the source code
made me speculate that <strong>M&rsquo;s must be the real operating system scheduled (kernel) threads, while G&rsquo;s (goroutines) must be the lightweight threads managed by the go runtime.</strong></p>

<p>I was more than happy to find comments that reassured that position of mine.</p>

<figure class='code'><figcaption><span>runtime.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="c1">// The go scheduler&#39;s job is to match ready-to-run goroutines (`g&#39;s)</span>
</span><span class='line'><span class="c1">// with waiting-for-work schedulers (`m&#39;s)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another cool finding was the go (runtime) scheduler &ndash; from which the above comment originates:</p>

<figure class='code'><figcaption><span>proc.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">struct</span> <span class="nx">Sched</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">Lock</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">G</span> <span class="o">*</span><span class="nx">gfree</span><span class="p">;</span> <span class="c1">// available g&#39;s (status == Gdead)</span>
</span><span class='line'>  <span class="kt">int64</span> <span class="nx">goidgen</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">G</span> <span class="o">*</span><span class="nx">ghead</span><span class="p">;</span> <span class="c1">// g&#39;s waiting to run</span>
</span><span class='line'>  <span class="nx">G</span> <span class="o">*</span><span class="nx">gtail</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int32</span> <span class="nx">gwait</span><span class="p">;</span> <span class="c1">// number of g&#39;s waiting to run</span>
</span><span class='line'>  <span class="kt">int32</span> <span class="nx">gcount</span><span class="p">;</span>    <span class="c1">// number of g&#39;s that are alive</span>
</span><span class='line'>  <span class="kt">int32</span> <span class="nx">grunning</span><span class="p">;</span>  <span class="c1">// number of g&#39;s running on cpu or in syscall</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">M</span> <span class="o">*</span><span class="nx">mhead</span><span class="p">;</span> <span class="c1">// m&#39;s waiting for work</span>
</span><span class='line'>  <span class="kt">int32</span> <span class="nx">mwait</span><span class="p">;</span> <span class="c1">// number of m&#39;s waiting for work</span>
</span><span class='line'>  <span class="kt">int32</span> <span class="nx">mcount</span><span class="p">;</span>    <span class="c1">// number of m&#39;s that have been created</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">volatile</span> <span class="kt">uint32</span> <span class="nx">atomic</span><span class="p">;</span>  <span class="c1">// atomic scheduling word (see below)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">int32</span> <span class="nx">profilehz</span><span class="p">;</span> <span class="c1">// cpu profiling rate</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">bool</span> <span class="nx">init</span><span class="p">;</span>  <span class="c1">// running initialization</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="nx">lockmain</span><span class="p">;</span>  <span class="c1">// init called runtime.LockOSThread</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">Note</span>    <span class="nx">stopped</span><span class="p">;</span> <span class="c1">// one g can set waitstop and wait here for m&#39;s to stop</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>From that particular piece of code, without a doubt the most interesting line is: <code>G *gfree</code>. That is a pool of the go routines that are available to be used.
There are also helper schedulling functions, from which, the most interesting (for my purposes), was the <code>static void gfput(G*);</code> which realeases a go routine (puts it to the gfree list)</p>

<figure class='code'><figcaption><span>proc.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="c1">// Put on gfree list.  Sched must be locked.</span>
</span><span class='line'><span class="nx">static</span> <span class="nx">void</span>
</span><span class='line'><span class="nx">gfput</span><span class="p">(</span><span class="nx">G</span> <span class="o">*</span><span class="nx">gp</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">gp</span><span class="o">-</span><span class="p">&gt;</span><span class="nx">schedlink</span> <span class="p">=</span> <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">gfree</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">runtime_sched</span><span class="p">.</span><span class="nx">gfree</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are loads of other extremely interesting functions there, but for the sake of space I will not expand here more. However I will expand on what it is that is confusing me:</p>

<h2>The source of confusion</h2>

<p>My tests in this point are to include testing if removing thread destruction from the go runtime would result in difference in behavior.
There are however (as far as go is concerned), two kinds of threads in the go runtime. <strong>Goroutines</strong> (G&rsquo;s) and the <strong>kernel schedulable threads</strong> (M&rsquo;s).</p>

<p>Neither of which, seem to really be destroyed. From my understanding so far, G&rsquo;s are never totally destroyed (I may be wrong here, I am still researching this bit). Whenever
they are about to &ldquo;destroyed&rdquo;, they are added to the scheduler&rsquo;s list of freeG&rsquo;s to allow for reuse, as evidenced by the <code>gfput</code> and <code>gfget</code> functions.
M&rsquo;s on the other hand (the kernel threads), also seem to not be destroyed. A comment in go&rsquo;s scheduler seems to support this (<code>// For now, m's never go away.</code>) and as a
matter of fact I could not find any code that destroyed M&rsquo;s (I am still researching this bit).</p>

<p><strong>Since none of the two actually get destroyed, and seeing as thread creation alone should not be buggy, how come we are facing the specific bugs we are facing?</strong>
I will try to provide with an interpretation: Either I am fairly wrong and M&rsquo;s (or G&rsquo;s or both) actually do get destroyed somewhere (possible and very much probable)
or I looking for clues regarding the issue in the wrong place (might be possible but I don&rsquo;t see it being very probable).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GSOC: Week 6 report]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/07/31/gsoc-week-6-report/"/>
    <updated>2013-07-31T12:36:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/07/31/gsoc-week-6-report</id>
    <content type="html"><![CDATA[<p>First of all, I would like to apologize for this report being late. But unfortunately this happened:
<img src="http://i1.kym-cdn.com/photos/images/original/000/000/376/Accidentally93mb20110724-22047-ix1t06.png" alt="I Accidentally 93 MB" /></p>

<p>Only that, in my case, it was not exactly 93 MB, rather it was about 1.5GB. Yeah, <em>I accidentally obliterated my <strong>GCC</strong> repository on the Hurd</em>, so I had to reclone and rebuild everything, something that took considerable amounts of time.
How this happened is a long story that involved me wanting to rebuild my gcc, and <code>cd</code>-ing 2 directories above the build folder, and ending up <code>rm -rf *</code> from my <code>gcc</code> folder (that included the source, and the build folder) rather than my <code>gcc_build</code> folder.
Thank god, that was only a minor setback, and the (small scale) crisis was soon averted.</p>

<h1>Further research</h1>

<p>This week was mostly spent reading source code, primarily looking for clues for the previous situation, and secondarily to get a better undestanding of the systems I am working on. This proved to be fertile, as I got a firmer grip of libpthread, and the GNU Mach system. However, while this week was mostly spent reading documentation, that doesn&rsquo;t mean that I didn&rsquo;t do anything practical. I also used my time to do some further research into what was it specifically that triggered the assertion failure. That required us to play a little bit with our newly built compiler on the Hurd and see what we can do with go on the Hurd.</p>

<h2>Testing gccgo under the Hurd</h2>

<p>If you recall correctly, the last time I reported I had found out that an assertion on <code>libpthread</code>`s code was failing, and that was the root cause that failed both the <code>gccgo</code> tests
and the <code>libgo</code> tests. That assertion was failing at two different places in the code, the first being <code>__pthread_create_internal</code> which is a <code>libpthread</code> function
located in <code>libpthread/pthread/pt-create.c</code> and is invoked when an application wants to create a new POSIX thread. That function of course is not getting called directly, rather
it is invoked by <code>pthread_create</code> which is the function that user space application use to create the new thread. (For reference reasons you can find the code <a href="https://github.com/NlightNFotis/libpthread/blob/master/pthread/pt-create.c#L67">here</a>)</p>

<p>The second place where that assertion was failing was at <code>__sem_timedwait_internal</code> at the file <a href="https://github.com/NlightNFotis/libpthread/blob/master/sysdeps/generic/sem-timedwait.c">libpthread/sysdeps/generic/sem-timedwait.c</a>, where it gets inlined in the place of <code>self = _pthread_self ();</code>. (For more information, checkout last week&rsquo;s report).</p>

<p>So I was curious to test out the execution of some sample programs under the compiler we built on the Hurd. <strong>Beginning with some very simple hello world like programs, we could see that
they were compiling successfully, and also ran successfully without any issues at all.</strong> Seeing as the assertion failure is generated when we attempt to create a new thread, I figured I might want to start playing with go routines under the Hurd.</p>

<p>So we started playing with a simple hello world like goroutine example (the one available under the <a href="http://tour.golang.org/#62">tour of go on the golang.org website.</a>)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>    <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>    <span class="s">&quot;time&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">say</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span><span class='line'>        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">go</span> <span class="nx">say</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">say</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This gets compiled without any issues at all, but when we try to run it&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">a</span><span class="p">.</span><span class="nx">out</span><span class="p">:</span> <span class="p">.</span><span class="o">/</span><span class="nx">pthread</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">sysdeps</span><span class="o">/</span><span class="nx">generic</span><span class="o">/</span><span class="nx">sem</span><span class="o">-</span><span class="nx">timedwait</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span> <span class="nx">__sem_timedwait_internal</span><span class="p">:</span> <span class="nx">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="nx">mach_port_t</span> <span class="nx">ktid</span> <span class="p">=</span> <span class="nx">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">thread</span><span class="o">-</span><span class="p">&gt;</span><span class="nx">kernel_thread</span> <span class="o">==</span> <span class="nx">ktid</span><span class="p">;</span> <span class="nx">__mach_port_deallocate</span> <span class="p">((</span><span class="nx">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">ktid</span><span class="p">);</span> <span class="nx">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="nx">failed</span><span class="p">.</span>
</span><span class='line'><span class="nx">Aborted</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nx">goroutine</span> <span class="mi">1</span> <span class="p">[</span><span class="nx">sleep</span><span class="p">]:</span>
</span><span class='line'><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span>
</span><span class='line'>  <span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">gcc_source</span><span class="o">/</span><span class="nx">libgo</span><span class="o">/</span><span class="nx">runtime</span><span class="o">/</span><span class="nx">time</span><span class="p">.</span><span class="nx">goc</span><span class="p">:</span><span class="mi">26</span>
</span><span class='line'>
</span><span class='line'><span class="nx">goroutine</span> <span class="mi">3</span> <span class="p">[</span><span class="nx">sleep</span><span class="p">]:</span>
</span><span class='line'><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span>
</span><span class='line'>  <span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">gcc_source</span><span class="o">/</span><span class="nx">libgo</span><span class="o">/</span><span class="nx">runtime</span><span class="o">/</span><span class="nx">time</span><span class="p">.</span><span class="nx">goc</span><span class="p">:</span><span class="mi">26</span>
</span></code></pre></td></tr></table></div></figure>


<p>Bam! It exploded right infront of our face. Let&rsquo;s see if this might become friendlier if we alter it a little bit. To do this we removed the <code>go</code> from <code>say</code> to avoid running it as a goroutine, and we also removed <code>time.Sleep</code> (along with the <code>time</code> import), <a href="https://github.com/NlightNFotis/gcc/blob/master/libgo/go/time/sleep.go#L8">whose job is to pause a go routine</a>.</p>

<p>When you do this, the code seems to be a hello world like for loop sample, that prints:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">root</span><span class="err">@</span><span class="nx">debian</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">Software</span><span class="o">/</span><span class="nx">Experiments</span><span class="o">/</span><span class="k">go</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="nx">a</span><span class="p">.</span><span class="nx">out</span>
</span><span class='line'><span class="nx">world</span>
</span><span class='line'><span class="nx">world</span>
</span><span class='line'><span class="nx">world</span>
</span><span class='line'><span class="nx">world</span>
</span><span class='line'><span class="nx">world</span>
</span><span class='line'><span class="nx">hello</span>
</span><span class='line'><span class="nx">hello</span>
</span><span class='line'><span class="nx">hello</span>
</span><span class='line'><span class="nx">hello</span>
</span><span class='line'><span class="nx">hello</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hmm. Let&rsquo;s play with it some more. Changing our code a little bit to make <code>say("world")</code> run as a goroutine gives us the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">say</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">go</span> <span class="nx">say</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">say</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which, when executed results in this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">root</span><span class="err">@</span><span class="nx">debian</span><span class="p">:</span><span class="err">~</span><span class="o">/</span><span class="nx">Software</span><span class="o">/</span><span class="nx">Experiments</span><span class="o">/</span><span class="k">go</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="nx">a</span><span class="p">.</span><span class="nx">out</span>
</span><span class='line'><span class="nx">a</span><span class="p">.</span><span class="nx">out</span><span class="p">:</span> <span class="p">.</span><span class="o">/</span><span class="nx">pthread</span><span class="o">/</span><span class="nx">pt</span><span class="o">-</span><span class="nx">create</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">167</span><span class="p">:</span> <span class="nx">__pthread_create_internal</span><span class="p">:</span> <span class="nx">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="nx">mach_port_t</span> <span class="nx">ktid</span> <span class="p">=</span> <span class="nx">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">thread</span><span class="o">-</span><span class="p">&gt;</span><span class="nx">kernel_thread</span> <span class="o">==</span> <span class="nx">ktid</span><span class="p">;</span>
</span><span class='line'><span class="nx">__mach_port_deallocate</span> <span class="p">((</span><span class="nx">__mach_task_self</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">ktid</span><span class="p">);</span> <span class="nx">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="nx">failed</span><span class="p">.</span>
</span><span class='line'><span class="nx">Aborted</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we can see that the simplest go programs that run with goroutines do not run. Let&rsquo;s still try some programs that invoke goroutines to see if our assumptions are correct.
Below is the code of a very simple web server in go (<a href="http://tour.golang.org/#56">found in the golang website</a>).</p>

<figure class='code'><figcaption><span>webserver.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>    <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>    <span class="s">&quot;net/http&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">type</span> <span class="nx">Hello</span> <span class="kd">struct</span><span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">Hello</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprint</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;Hello!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">h</span> <span class="nx">Hello</span>
</span><span class='line'>    <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;localhost:4000&quot;</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The (non surprising) result is the following:</p>

<figure class='code'><figcaption><span>webserver.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">a</span><span class="p">.</span><span class="nx">out</span><span class="p">:</span> <span class="p">.</span><span class="o">/</span><span class="nx">pthread</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">sysdeps</span><span class="o">/</span><span class="nx">generic</span><span class="o">/</span><span class="nx">sem</span><span class="o">-</span><span class="nx">timedwait</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span> <span class="nx">__sem_timedwait_internal</span><span class="p">:</span> <span class="nx">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="nx">mach_port_t</span> <span class="nx">ktid</span> <span class="p">=</span> <span class="nx">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">thread</span><span class="o">-</span><span class="p">&gt;</span><span class="nx">kernel_thread</span> <span class="o">==</span> <span class="nx">ktid</span><span class="p">;</span> <span class="nx">__mach_port_deallocate</span> <span class="p">((</span><span class="nx">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">ktid</span><span class="p">);</span> <span class="nx">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="nx">failed</span><span class="p">.</span>
</span><span class='line'><span class="nx">Aborted</span>
</span><span class='line'>
</span><span class='line'><span class="nx">goroutine</span> <span class="mi">1</span> <span class="p">[</span><span class="nx">syscall</span><span class="p">]:</span>
</span><span class='line'><span class="nx">no</span> <span class="nx">stack</span> <span class="nx">trace</span> <span class="nx">available</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hmm. This failure was last caused by <code>time.Sleep</code>. So let&rsquo;s take a closer look into the code of the <code>ListenAndServe</code> function. The code for this function in the go runtime is this:</p>

<figure class='code'><figcaption><span>gcc/libgo/go/net/http/server.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="c1">// ListenAndServe listens on the TCP network address srv.Addr and then</span>
</span><span class='line'><span class="c1">// calls Serve to handle requests on incoming connections.  If</span>
</span><span class='line'><span class="c1">// srv.Addr is blank, &quot;:http&quot; is used.</span>
</span><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nx">ListenAndServe</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">addr</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Addr</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">addr</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">addr</span> <span class="p">=</span> <span class="s">&quot;:http&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">l</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">e</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This calls the function <a href="https://github.com/NlightNFotis/gcc/blob/master/libgo/go/net/http/server.go#L1255"><code>Serve</code></a>. The interesting part in this one is line 1271:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'> <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">tempDelay</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It calls <code>time.Sleep</code> on accept failure. Which is known to pause go routines, and as a result be the ultimate cause for the result we are seeing.</p>

<h1>Final thoughts &ndash; Work for next week</h1>

<p>So pretty much everything that has anything to do with a goroutine is failing. Richard Braun on the #hurd suggested that since <strong>creation and destruction</strong> of threads is buggy in libpthread, maybe we should try a work around until a proper fix is in place.
Apart from that my mentor Thomas Schwinge suggested to make thread destruction in go&rsquo;s runtime a no-op to see if that makes any difference.
If it does that should mean that there is nothing wrong in the go runtime itself, rather, the offending code is in libpthread. This is also my very next course of action, which I shall report on very soon.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GSOC: Week 5 report]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/07/24/gsoc-week-5-report/"/>
    <updated>2013-07-24T12:36:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/07/24/gsoc-week-5-report</id>
    <content type="html"><![CDATA[<h1>A clue!</h1>

<p><strong>So last week we were left with the compiler test logs and the build results logs that we had to go through to checkout what was the root cause of all these failures in the gccgo test results, and more importantly in the libgo tests.</strong> So I went through the gccgo logs in search for a clue about why this may have happened. Here is the list of all the failures I compiled from the logs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>spawn [open ...]^M
</span><span class='line'>doubleselect.x: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate ((__mach_task_s      elf_ + 0), ktid); ok; })' failed.
</span><span class='line'>FAIL: go.test/test/chan/doubleselect.go execution,  -O2 -g
</span><span class='line'>
</span><span class='line'>==========================================================
</span><span class='line'>
</span><span class='line'>spawn [open ...]^M
</span><span class='line'>nonblock.x: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate ((__mach_task_self_       + 0), ktid); ok; })' failed.
</span><span class='line'>FAIL: go.test/test/chan/nonblock.go execution,  -O2 -g
</span><span class='line'>
</span><span class='line'>==========================================================
</span><span class='line'>
</span><span class='line'>Executing on host: /root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo -B/root/gcc_new/gccbuild/gcc/testsuite/go/../../  -fno-diagnostics-show-caret -fdiagnostics-color=never  -I/root/gcc_new/gccbuild/i68      6-unknown-gnu0.3/./libgo  -fsplit-stack -c  -o split_stack376.o split_stack376.c    (timeout = 300)
</span><span class='line'>spawn /root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo -B/root/gcc_new/gccbuild/gcc/testsuite/go/../../ -fno-diagnostics-show-caret -fdiagnostics-color=never -I/root/gcc_new/gccbuild/i686-unknown-gnu0.      3/./libgo -fsplit-stack -c -o split_stack376.o split_stack376.c^M
</span><span class='line'>cc1: error: '-fsplit-stack' currently only supported on GNU/Linux^M
</span><span class='line'>cc1: error: '-fsplit-stack' is not supported by this compiler configuration^M
</span><span class='line'>compiler exited with status 1
</span><span class='line'>output is:
</span><span class='line'> cc1: error: '-fsplit-stack' currently only supported on GNU/Linux^M
</span><span class='line'> cc1: error: '-fsplit-stack' is not supported by this compiler configuration^M 
</span><span class='line'>
</span><span class='line'>UNTESTED: go.test/test/chan/select2.go
</span><span class='line'>
</span><span class='line'>==========================================================
</span><span class='line'>
</span><span class='line'>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
</span><span class='line'>spawn [open ...]^M
</span><span class='line'>select3.x: ./pthread/../sysdeps/generic/sem-timedwait.c:50: __sem_timedwait_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate       ((__mach_task_self_ + 0), ktid); ok; })' failed.
</span><span class='line'>Aborted
</span><span class='line'> 
</span><span class='line'>FAIL: go.test/test/chan/select3.go execution,  -O2 -g
</span><span class='line'>
</span><span class='line'>==========================================================
</span><span class='line'>
</span><span class='line'>Executing on host: /root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo -B/root/gcc_new/gccbuild/gcc/testsuite/go/../../ /root/gcc_new/gcc/gcc/testsuite/go.test/test/chan/select5.go  -fno-diagnostics-show-      caret -fdiagnostics-color=never  -I/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo  -O  -w  -pedantic-errors  -L/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo -L/root/gcc_new/gccbuild/i686-unknown-      gnu0.3/./libgo/.libs  -lm   -o select5.exe    (timeout = 300)
</span><span class='line'>spawn /root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo -B/root/gcc_new/gccbuild/gcc/testsuite/go/../../ /root/gcc_new/gcc/gcc/testsuite/go.test/test/chan/select5.go -fno-diagnostics-show-caret -fdiagno      stics-color=never -I/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo -O -w -pedantic-errors -L/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo -L/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.lib      s -lm -o select5.exe^M
</span><span class='line'>PASS: go.test/test/chan/select5.go -O (test for excess errors)
</span><span class='line'>FAIL: go.test/test/chan/select5.go execution
</span><span class='line'>
</span><span class='line'>==========================================================
</span><span class='line'>
</span><span class='line'>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
</span><span class='line'>spawn [open ...]^M
</span><span class='line'>bug147.x: ./pthread/../sysdeps/generic/sem-timedwait.c:50: __sem_timedwait_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate       ((__mach_task_self_ + 0), ktid); ok; })' failed.
</span><span class='line'>Aborted
</span><span class='line'> 
</span><span class='line'>FAIL: go.test/test/fixedbugs/bug147.go execution,  -O2 -g
</span><span class='line'>
</span><span class='line'>=========================================================
</span><span class='line'>
</span><span class='line'>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
</span><span class='line'>spawn [open ...]^M
</span><span class='line'>BUG: bug347: cannot find caller
</span><span class='line'>Aborted
</span><span class='line'> 
</span><span class='line'> 
</span><span class='line'>FAIL: go.test/test/fixedbugs/bug347.go execution,  -O0 -g
</span><span class='line'>
</span><span class='line'>========================================================
</span><span class='line'>
</span><span class='line'>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
</span><span class='line'>spawn [open ...]^M
</span><span class='line'>BUG: bug348: cannot find caller
</span><span class='line'>panic: runtime error: invalid memory address or nil pointer dereference
</span><span class='line'>[signal 0xb code=0x2 addr=0x0]
</span><span class='line'> 
</span><span class='line'>goroutine 1 [running]:
</span><span class='line'>FAIL: go.test/test/fixedbugs/bug348.go execution,  -O0 -g
</span><span class='line'>
</span><span class='line'>========================================================
</span><span class='line'>
</span><span class='line'>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
</span><span class='line'>spawn [open ...]^M
</span><span class='line'>mallocfin.x: ./pthread/pt-create.c:167: __pthread_create_internal: Assertion `({ mach_port_t ktid = __mach_thread_self (); int ok = thread-&gt;kernel_thread == ktid; __mach_port_deallocate ((__mach_task_self      _ + 0), ktid); ok; })' failed.
</span><span class='line'>FAIL: go.test/test/mallocfin.go execution,  -O2 -g
</span><span class='line'>
</span><span class='line'>=======================================================
</span><span class='line'>
</span><span class='line'>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
</span><span class='line'>spawn [open ...]^M
</span><span class='line'>Aborted
</span><span class='line'> 
</span><span class='line'> 
</span><span class='line'>FAIL: go.test/test/nil.go execution,  -O2 -g
</span><span class='line'>
</span><span class='line'>======================================================
</span><span class='line'>
</span><span class='line'>Setting LD_LIBRARY_PATH to .:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:.:/root/gcc_new/gccbuild/i686-unknown-gnu0.3/./libgo/.libs:/root/gcc_new/gccbuild/gcc:/root      /gcc_new/gccbuild/./gmp/.libs:/root/gcc_new/gccbuild/./prev-gmp/.libs:/root/gcc_new/gccbuild/./mpfr/.libs:/root/gcc_new/gccbuild/./prev-mpfr/.libs:/root/gcc_new/gccbuild/./mpc/.libs:/root/gcc_new/gccbuild      /./prev-mpc/.libs
</span><span class='line'>spawn [open ...]^M
</span><span class='line'>Aborted
</span><span class='line'> 
</span><span class='line'> 
</span><span class='line'>FAIL: go.test/test/recover3.go execution,  -O2 -g
</span></code></pre></td></tr></table></div></figure>


<p><em>See a pattern there?</em> Well certainly I do. In several occasions, the root cause for the fail is this:</p>

<figure class='code'><figcaption><span>Assertion fail</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span>       <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hmm&hellip; That&rsquo;s interesting. Let us go through the libgo results too.</p>

<figure class='code'><figcaption><span>Assertion fail</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">Test</span> <span class="n">Run</span> <span class="n">By</span> <span class="n">root</span> <span class="n">on</span> <span class="n">Fri</span> <span class="n">Jul</span> <span class="mi">12</span> <span class="mi">17</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mi">44</span> <span class="n">UTC</span> <span class="mi">2013</span>
</span><span class='line'><span class="n">Native</span> <span class="n">configuration</span> <span class="n">is</span> <span class="n">i686</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">gnu0</span><span class="mf">.3</span>
</span><span class='line'>
</span><span class='line'>      <span class="o">===</span> <span class="n">libgo</span> <span class="n">tests</span> <span class="o">===</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">10005</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">bufio</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">10005</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">10637</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">bytes</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">10637</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">10757</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">errors</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">10757</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">generic</span><span class="o">/</span><span class="n">sem</span><span class="o">-</span><span class="n">timedwait</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">50</span><span class="o">:</span> <span class="n">__sem_timedwait_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="n">Aborted</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">goroutine</span> <span class="mi">1</span> <span class="p">[</span><span class="n">syscall</span><span class="p">]</span><span class="o">:</span>
</span><span class='line'><span class="n">no</span> <span class="n">stack</span> <span class="n">trace</span> <span class="n">available</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">expvar</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">10886</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">11058</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">flag</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">11058</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">11475</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">fmt</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">11475</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">11584</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">html</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">11584</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">11747</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">image</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">11747</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">11999</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">io</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">11999</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">12116</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">log</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">12116</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">13107</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">math</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">13107</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">13271</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">mime</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">13271</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">generic</span><span class="o">/</span><span class="n">sem</span><span class="o">-</span><span class="n">timedwait</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">50</span><span class="o">:</span> <span class="n">__sem_timedwait_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="n">Aborted</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">goroutine</span> <span class="mi">1</span> <span class="p">[</span><span class="n">chan</span> <span class="n">receive</span><span class="p">]</span><span class="o">:</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">generic</span><span class="o">/</span><span class="n">sem</span><span class="o">-</span><span class="n">timedwait</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">50</span><span class="o">:</span> <span class="n">__sem_timedwait_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="n">panic</span> <span class="n">during</span> <span class="n">panic</span>
</span><span class='line'><span class="n">testing</span><span class="p">.</span><span class="n">RunTestsFAIL</span><span class="o">:</span> <span class="n">net</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">14234</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">14699</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">os</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">484</span><span class="o">:</span> <span class="n">kill</span><span class="o">:</span> <span class="p">(</span><span class="mi">14699</span><span class="p">)</span> <span class="o">-</span> <span class="n">No</span> <span class="n">such</span> <span class="n">process</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="o">:</span> <span class="p">.</span><span class="o">/</span><span class="n">pthread</span><span class="o">/</span><span class="n">pt</span><span class="o">-</span><span class="n">create</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">167</span><span class="o">:</span> <span class="n">__pthread_create_internal</span><span class="o">:</span> <span class="n">Assertion</span> <span class="err">`</span><span class="p">({</span> <span class="n">mach_port_t</span> <span class="n">ktid</span> <span class="o">=</span> <span class="n">__mach_thread_self</span> <span class="p">();</span> <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">kernel_thread</span> <span class="o">==</span> <span class="n">ktid</span><span class="p">;</span> <span class="n">__mach_port_deallocate</span> <span class="p">((</span><span class="n">__mach_task_self_</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ktid</span><span class="p">);</span> <span class="n">ok</span><span class="p">;</span> <span class="p">})</span><span class="err">&#39;</span> <span class="n">failed</span><span class="p">.</span>
</span><span class='line'><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">libgo</span><span class="o">/</span><span class="n">testsuite</span><span class="o">/</span><span class="n">gotest</span><span class="o">:</span> <span class="n">line</span> <span class="mi">486</span><span class="o">:</span> <span class="mi">14860</span> <span class="n">Aborted</span>                 <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="kt">short</span> <span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">timeout</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">s</span> <span class="s">&quot;$@&quot;</span>
</span><span class='line'><span class="nl">FAIL:</span> <span class="n">path</span>
</span><span class='line'><span class="n">timed</span> <span class="n">out</span> <span class="n">in</span> <span class="n">gotest</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">runtest</span> <span class="n">completed</span> <span class="n">at</span> <span class="n">Fri</span> <span class="n">Jul</span> <span class="mi">12</span> <span class="mi">18</span><span class="o">:</span><span class="mi">09</span><span class="o">:</span><span class="mo">07</span> <span class="n">UTC</span> <span class="mi">2013</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s certainly even more interesting. In case you haven&rsquo;t noticed, it&rsquo;s the same assertion that caused the failures in gccgo test suite. Let us find the offending code, shall we?</p>

<figure class='code'><figcaption><span>libpthread/pthread/pt-create.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Set the new thread&#39;s signal mask and set the pending signals to</span>
</span><span class='line'><span class="cm">     empty.  POSIX says: &quot;The signal mask shall be inherited from the</span>
</span><span class='line'><span class="cm">     creating thread.  The set of signals pending for the new thread</span>
</span><span class='line'><span class="cm">     shall be empty.&quot;  If the currnet thread is not a pthread then we</span>
</span><span class='line'><span class="cm">     just inherit the process&#39; sigmask.  */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">__pthread_num_threads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">err</span> <span class="o">=</span> <span class="n">sigprocmask</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sigset</span><span class="p">);</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">err</span> <span class="o">=</span> <span class="n">__pthread_sigstate</span> <span class="p">(</span><span class="n">_pthread_self</span> <span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sigset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">assert_perror</span> <span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This seems to be the code that the logs point to. But no sign of the assertion. After discussing this issue with my peers in #hurd, I was told that the code I was looking for (the failing assertion), is getting inlined via <code>_pthread_self ()</code> and is actually located in <code>libpthread/sysdeps/mach/hurd/pt-sysdep.h</code>.</p>

<figure class='code'><figcaption><span>libpthread/sysdeps/mach/hurd/pt-sysdep.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">extern</span> <span class="n">__thread</span> <span class="k">struct</span> <span class="n">__pthread</span> <span class="o">*</span><span class="n">___pthread_self</span><span class="p">;</span>
</span><span class='line'><span class="cp">#define _pthread_self()                                            \</span>
</span><span class='line'><span class="cp"> ({                                                         \</span>
</span><span class='line'><span class="cp">   struct __pthread *thread;                                \</span>
</span><span class='line'><span class="cp">                                                            \</span>
</span><span class='line'><span class="cp">   assert (__pthread_threads);                              \</span>
</span><span class='line'><span class="cp">   thread = ___pthread_self;                                \</span>
</span><span class='line'><span class="cp">                                                            \</span>
</span><span class='line'><span class="cp">   assert (thread);                                         \</span>
</span><span class='line'><span class="cp">   assert (({ mach_port_t ktid = __mach_thread_self ();     \</span>
</span><span class='line'><span class="cp">                     int ok = thread-&gt;kernel_thread == ktid;       \</span>
</span><span class='line'><span class="cp">                     __mach_port_deallocate (__mach_task_self (), ktid);\</span>
</span><span class='line'><span class="cp">                     ok; }));                                      \</span>
</span><span class='line'><span class="cp">          thread;                                                  \</span>
</span><span class='line'><span class="cp">         })</span>
</span></code></pre></td></tr></table></div></figure>


<p>So this is what I was looking for. Further discussing it in the weekly IRC meeting, braunr provided me with some more clues:</p>

<blockquote><p>08:38:15 braunr> nlightnfotis: did i answer that ?<br/>
08:38:24 nlightnfotis> braunr: which one?<br/>
08:38:30 nlightnfotis> hello btw :)<br/>
08:38:33 braunr> the problems you&rsquo;re seeing are the pthread resources leaks i&rsquo;ve been trying to fix lately<br/>
08:38:58 braunr> they&rsquo;re not only leaks<br/>
08:39:08 braunr> creation and destruction are buggy <br/>
08:39:37 nlightnfotis> I have read so in <a href="http://www.gnu.org/software/hurd/libpthread.html.">http://www.gnu.org/software/hurd/libpthread.html.</a> I believe it&rsquo;s under Thread&rsquo;s Death right?<br/>
08:40:15 braunr> nlightnfotis: yes but it&rsquo;s buggy<br/>
08:40:22 braunr> and the description doesn&rsquo;t describe the bugs<br/>
08:41:02 nlightnfotis> so we will either have to find a temporary workaround, or better yet work on a fix, right?<br/>
08:41:12 braunr> nlightnfotis: i also told you the work around<br/>
08:41:16 braunr> nlightnfotis: create a thread pool</p></blockquote>

<h1>Work for next week</h1>

<p>This leaves us with next week&rsquo;s work, which is to hack in libpthread&rsquo;s code to attempt to create a thread pool, so that we avoid some of the issues that are present now with the current implementation of the Hurd libpthread code.</p>

<p>It was also suggested by Samuel Thibault (youpi) that I should run the libgo tests by hand and see if I get some more clues, like stack traces. It sounds like a good idea to me, so that&rsquo;s something that I will look into too.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GSOC: Week 4 report]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/07/15/gsoc-week-4-report/"/>
    <updated>2013-07-15T11:43:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/07/15/gsoc-week-4-report</id>
    <content type="html"><![CDATA[<h1>Yeah baby! It builds!</h1>

<p><strong>The highlight of this week&rsquo;s progress was managing to successfully build
gccgo under the Hurd.</strong>
Not only did it compile successfully, it also run its tests, with the
results <a href="http://lists.gnu.org/archive/html/bug-hurd/2013-06/msg00117.html">matching the ones provided by my mentor Thomas Schwinge</a>.
This was a checkpoint in my summer of code project. Successful building of
the compiler meant that I am (happily) in the position to carry on with the
next part (and the main one) of my project, that is, to make sure that
the <strong>go library (libgo) also passes all its tests
and works without any major issues.</strong></p>

<h1>So where are we now?</h1>

<h2>gccgo</h2>

<p>Compiling gccgo on the Hurd was big. But we also had to see how it
compared to the build that was successful on Linux. The most effective
way to compare the two builds, is to check the test results of the two.</p>

<p>Taking a look at the gccgo results on the Hurd, I was delighted to find
that it passed most of its tests. There were few that were failing, but
for the most part, it did well. Below are the test results of gccgo on the Hurd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> === go Summary ===
</span><span class='line'>
</span><span class='line'># of expected passes        5069
</span><span class='line'># of unexpected failures    11
</span><span class='line'># of expected failures      1
</span><span class='line'># of untested testcases     6
</span><span class='line'>/root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo  version 4.9.0 20130606 (experimental) (GCC)
</span></code></pre></td></tr></table></div></figure>


<p>So it&rsquo;s passing 99% of its tests. That&rsquo;s cool. But it could help to take a look
at the tests that are failing, to get an idea of what the fails are, how critical they are, etc</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nlightnfotis@earth:~/HurdVM/HurdFiles$ grep -v ^PASS: &lt; go.sum
</span><span class='line'>Test Run By root on Thu Jul 11 10:33:34 2013
</span><span class='line'>Native configuration is i686-unknown-gnu0.3
</span><span class='line'>
</span><span class='line'>        === go tests ===
</span><span class='line'>
</span><span class='line'>        Schedule of variations:
</span><span class='line'>            unix
</span><span class='line'>
</span><span class='line'>            Running target unix
</span><span class='line'>            Running /root/gcc_new/gcc/gcc/testsuite/go.dg/dg.exp ...
</span><span class='line'>            Running /root/gcc_new/gcc/gcc/testsuite/go.go-torture/execute/execute.exp ...
</span><span class='line'>            Running /root/gcc_new/gcc/gcc/testsuite/go.test/go-test.exp ...
</span><span class='line'>            FAIL: go.test/test/chan/doubleselect.go execution,  -O2 -g 
</span><span class='line'>            FAIL: go.test/test/chan/nonblock.go execution,  -O2 -g 
</span><span class='line'>            UNTESTED: go.test/test/chan/select2.go
</span><span class='line'>            FAIL: go.test/test/chan/select3.go execution,  -O2 -g 
</span><span class='line'>            FAIL: go.test/test/chan/select5.go execution
</span><span class='line'>            UNTESTED: go.test/test/closure.go
</span><span class='line'>            FAIL: go.test/test/fixedbugs/bug147.go execution,  -O2 -g 
</span><span class='line'>            FAIL: go.test/test/fixedbugs/bug347.go execution,  -O0 -g 
</span><span class='line'>            FAIL: go.test/test/fixedbugs/bug348.go execution,  -O0 -g 
</span><span class='line'>            XFAIL: bug429.go  -O2 -g  execution test
</span><span class='line'>            FAIL: go.test/test/goprint.go execution
</span><span class='line'>            UNTESTED: go.test/test/goprint.go compare
</span><span class='line'>            UNTESTED: go.test/test/init1.go
</span><span class='line'>            FAIL: go.test/test/mallocfin.go execution,  -O2 -g 
</span><span class='line'>            FAIL: go.test/test/nil.go execution,  -O2 -g 
</span><span class='line'>            FAIL: go.test/test/recover3.go execution,  -O2 -g 
</span><span class='line'>            UNTESTED: go.test/test/rotate.go
</span><span class='line'>            UNTESTED: go.test/test/stack.go
</span><span class='line'>
</span><span class='line'>                    === go Summary ===
</span><span class='line'>
</span><span class='line'># of expected passes        5069
</span><span class='line'># of unexpected failures    11
</span><span class='line'># of expected failures      1
</span><span class='line'># of untested testcases     6
</span><span class='line'>/root/gcc_new/gccbuild/gcc/testsuite/go/../../gccgo  version 4.9.0 20130606 (experimental) (GCC) </span></code></pre></td></tr></table></div></figure>


<p>Hmm. So these are the failing tests. Before we go through them, it might be a good idea
to check the status of the gccgo tests on the Linux build too. Let&rsquo;s see.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nlightnfotis@earth:~$ grep -v ^PASS: &lt; linux_go.sum 
</span><span class='line'>Test Run By fotis on Mon Jul 15 10:28:38 2013
</span><span class='line'>Native configuration is i686-pc-linux-gnu
</span><span class='line'>
</span><span class='line'>        === go tests ===
</span><span class='line'>
</span><span class='line'>        Schedule of variations:
</span><span class='line'>            unix
</span><span class='line'>
</span><span class='line'>            Running target unix
</span><span class='line'>            Running /home/fotis/Software/gcc/gcc/testsuite/go.dg/dg.exp ...
</span><span class='line'>            Running /home/fotis/Software/gcc/gcc/testsuite/go.go-torture/execute/execute.exp ...
</span><span class='line'>            Running /home/fotis/Software/gcc/gcc/testsuite/go.test/go-test.exp ...
</span><span class='line'>            UNTESTED: go.test/test/closure.go
</span><span class='line'>            XFAIL: bug429.go  -O2 -g  execution test
</span><span class='line'>            UNTESTED: go.test/test/init1.go
</span><span class='line'>            UNTESTED: go.test/test/rotate.go
</span><span class='line'>
</span><span class='line'>                    === go Summary ===
</span><span class='line'>
</span><span class='line'># of expected passes        5183
</span><span class='line'># of expected failures      1
</span><span class='line'># of untested testcases     3
</span><span class='line'>/home/fotis/Software/gcc_build/gcc/testsuite/go/../../gccgo  version 4.9.0 20130702 (experimental) (GCC) </span></code></pre></td></tr></table></div></figure>


<p>So, it seems like there are less tests failing here. But wait a minute. Those tests that are failing.
They are the same as with the Hurd build. So I can assume that we are left with 4 less tests to check
regarding their failures (Go on Linux works without any issues,so I guess it would be safe to skip those tests at the moment).
That leaves us with these tests to check:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FAIL: go.test/test/chan/doubleselect.go execution,  -O2 -g
</span><span class='line'>FAIL: go.test/test/chan/nonblock.go execution,  -O2 -g
</span><span class='line'>UNTESTED: go.test/test/chan/select2.go
</span><span class='line'>FAIL: go.test/test/chan/select3.go execution,  -O2 -g
</span><span class='line'>FAIL: go.test/test/chan/select5.go execution
</span><span class='line'>FAIL: go.test/test/fixedbugs/bug147.go execution,  -O2 -g
</span><span class='line'>FAIL: go.test/test/fixedbugs/bug347.go execution,  -O0 -g
</span><span class='line'>FAIL: go.test/test/fixedbugs/bug348.go execution,  -O0 -g
</span><span class='line'>FAIL: go.test/test/goprint.go execution
</span><span class='line'>UNTESTED: go.test/test/goprint.go compare
</span><span class='line'>FAIL: go.test/test/mallocfin.go execution,  -O2 -g
</span><span class='line'>FAIL: go.test/test/nil.go execution,  -O2 -g
</span><span class='line'>FAIL: go.test/test/recover3.go execution,  -O2 -g
</span><span class='line'>UNTESTED: go.test/test/stack.go</span></code></pre></td></tr></table></div></figure>


<p>Discussing this with my mentor <a href="https://plus.google.com/101468009864620818344">Thomas Schwinge</a> in IRC (#hurd)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;tschwinge&gt; For now, please ignore any failing tests that have select in their name -- that is, do file them, but do not spend a lot of time figuring out what might be wrong there.
</span><span class='line'>&lt;tschwinge&gt; The Hurd's select implementation is a bit of a beast, and I don't want you -- at this time -- spend a lot of time on that.  We already know there are some deficiencies, so we should postpone that to later.</span></code></pre></td></tr></table></div></figure>


<p>So that leaves us with even less tests to check:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FAIL: go.test/test/chan/nonblock.go execution,  -O2 -g
</span><span class='line'>FAIL: go.test/test/fixedbugs/bug147.go execution,  -O2 -g
</span><span class='line'>FAIL: go.test/test/fixedbugs/bug347.go execution,  -O0 -g
</span><span class='line'>FAIL: go.test/test/fixedbugs/bug348.go execution,  -O0 -g
</span><span class='line'>FAIL: go.test/test/goprint.go execution
</span><span class='line'>UNTESTED: go.test/test/goprint.go compare
</span><span class='line'>FAIL: go.test/test/mallocfin.go execution,  -O2 -g
</span><span class='line'>FAIL: go.test/test/nil.go execution,  -O2 -g
</span><span class='line'>FAIL: go.test/test/recover3.go execution,  -O2 -g
</span><span class='line'>UNTESTED: go.test/test/stack.go</span></code></pre></td></tr></table></div></figure>


<p>Nice. <strong>This narrowed down the list of errors that I have to go through to make sure that gccgo
works as well on the Hurd as it does on Linux.</strong></p>

<h2>libgo</h2>

<p>So, we talked about gccgo, but what about the runtime libraries (libgo)? They are also getting
tested when we run <code>make check-go</code>and seeing as they are a vital part
of enabling programs written on go to run on the Hurd, we ought
to take a look. (This was also the original goal of my project proposal).</p>

<p>So let us see what we have at the libgo.sum:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Test Run By root on Fri Jul 12 17:56:44 UTC 2013
</span><span class='line'>Native configuration is i686-unknown-gnu0.3
</span><span class='line'>
</span><span class='line'>        === libgo tests ===
</span><span class='line'>
</span><span class='line'>        Schedule of variations:
</span><span class='line'>            unix
</span><span class='line'>
</span><span class='line'>            Running target unix
</span><span class='line'>            Running ../../../gcc/libgo/libgo.exp ...
</span><span class='line'>            FAIL: bufio
</span><span class='line'>            FAIL: bytes
</span><span class='line'>            FAIL: errors
</span><span class='line'>            FAIL: expvar
</span><span class='line'>            FAIL: flag
</span><span class='line'>            FAIL: fmt
</span><span class='line'>            FAIL: html
</span><span class='line'>            FAIL: image
</span><span class='line'>            FAIL: io
</span><span class='line'>            FAIL: log
</span><span class='line'>            FAIL: math
</span><span class='line'>            FAIL: mime
</span><span class='line'>            FAIL: net
</span><span class='line'>            FAIL: os
</span><span class='line'>            FAIL: path
</span><span class='line'>            FAIL: reflect
</span><span class='line'>            FAIL: regexp
</span><span class='line'>            FAIL: runtime
</span><span class='line'>            FAIL: sort
</span><span class='line'>            FAIL: strconv
</span><span class='line'>            FAIL: strings
</span><span class='line'>            FAIL: sync
</span><span class='line'>            FAIL: syscall
</span><span class='line'>            FAIL: time
</span><span class='line'>            FAIL: unicode
</span><span class='line'>            FAIL: archive/tar
</span><span class='line'>            FAIL: archive/zip
</span><span class='line'>            FAIL: compress/bzip2
</span><span class='line'>            FAIL: compress/flate
</span><span class='line'>            FAIL: compress/gzip
</span><span class='line'>            FAIL: compress/lzw
</span><span class='line'>            FAIL: compress/zlib
</span><span class='line'>            FAIL: container/heap
</span><span class='line'>            FAIL: container/list
</span><span class='line'>            FAIL: container/ring
</span><span class='line'>            FAIL: crypto/aes
</span><span class='line'>            FAIL: crypto/cipher
</span><span class='line'>            FAIL: crypto/des
</span><span class='line'>            FAIL: crypto/dsa
</span><span class='line'>            FAIL: crypto/ecdsa
</span><span class='line'>            FAIL: crypto/elliptic
</span><span class='line'>            FAIL: crypto/hmac
</span><span class='line'>            FAIL: crypto/md5
</span><span class='line'>            FAIL: crypto/rand
</span><span class='line'>            FAIL: crypto/rc4
</span><span class='line'>            FAIL: crypto/rsa
</span><span class='line'>            FAIL: crypto/sha1
</span><span class='line'>            FAIL: crypto/sha256
</span><span class='line'>            FAIL: crypto/sha512
</span><span class='line'>            FAIL: crypto/subtle
</span><span class='line'>            FAIL: crypto/tls
</span><span class='line'>            FAIL: crypto/x509
</span><span class='line'>            FAIL: database/sql
</span><span class='line'>            FAIL: database/sql/driver
</span><span class='line'>            FAIL: debug/dwarf
</span><span class='line'>            FAIL: debug/elf
</span><span class='line'>            FAIL: debug/macho
</span><span class='line'>            FAIL: debug/pe
</span><span class='line'>            FAIL: encoding/ascii85
</span><span class='line'>            FAIL: encoding/asn1
</span><span class='line'>            FAIL: encoding/base32
</span><span class='line'>            FAIL: encoding/base64
</span><span class='line'>            FAIL: encoding/binary
</span><span class='line'>            FAIL: encoding/csv
</span><span class='line'>            FAIL: encoding/gob
</span><span class='line'>            FAIL: encoding/hex
</span><span class='line'>            FAIL: encoding/json
</span><span class='line'>            FAIL: encoding/pem
</span><span class='line'>            PASS: encoding/xml
</span><span class='line'>            FAIL: exp/cookiejar
</span><span class='line'>            FAIL: exp/ebnf
</span><span class='line'>            FAIL: exp/html
</span><span class='line'>            FAIL: exp/html/atom
</span><span class='line'>            FAIL: exp/locale/collate
</span><span class='line'>            FAIL: exp/locale/collate/build
</span><span class='line'>            FAIL: exp/norm
</span><span class='line'>            FAIL: exp/proxy
</span><span class='line'>            FAIL: exp/terminal
</span><span class='line'>            FAIL: exp/utf8string
</span><span class='line'>            FAIL: html/template
</span><span class='line'>            FAIL: go/ast
</span><span class='line'>            FAIL: go/doc
</span><span class='line'>            FAIL: go/format
</span><span class='line'>            FAIL: go/parser
</span><span class='line'>            FAIL: go/printer
</span><span class='line'>            FAIL: go/scanner
</span><span class='line'>            FAIL: go/token
</span><span class='line'>            FAIL: go/types
</span><span class='line'>            FAIL: hash/adler32
</span><span class='line'>            FAIL: hash/crc32
</span><span class='line'>            FAIL: hash/crc64
</span><span class='line'>            FAIL: hash/fnv
</span><span class='line'>            FAIL: image/color
</span><span class='line'>            FAIL: image/draw
</span><span class='line'>            FAIL: image/jpeg
</span><span class='line'>            FAIL: image/png
</span><span class='line'>            FAIL: index/suffixarray
</span><span class='line'>            FAIL: io/ioutil
</span><span class='line'>            FAIL: log/syslog
</span><span class='line'>            FAIL: math/big
</span><span class='line'>            FAIL: math/cmplx
</span><span class='line'>            FAIL: math/rand
</span><span class='line'>            FAIL: mime/multipart
</span><span class='line'>            FAIL: net/http
</span><span class='line'>            FAIL: net/http/cgi
</span><span class='line'>            FAIL: net/http/fcgi
</span><span class='line'>            FAIL: net/http/httptest
</span><span class='line'>            FAIL: net/http/httputil
</span><span class='line'>            FAIL: net/mail
</span><span class='line'>            FAIL: net/rpc
</span><span class='line'>            FAIL: net/smtp
</span><span class='line'>            FAIL: net/textproto
</span><span class='line'>            FAIL: net/url
</span><span class='line'>            FAIL: net/rpc/jsonrpc
</span><span class='line'>            FAIL: old/netchan
</span><span class='line'>            FAIL: old/regexp
</span><span class='line'>            FAIL: old/template
</span><span class='line'>            FAIL: os/exec
</span><span class='line'>            FAIL: os/signal
</span><span class='line'>            FAIL: os/user
</span><span class='line'>            FAIL: path/filepath
</span><span class='line'>            FAIL: regexp/syntax
</span><span class='line'>            FAIL: runtime/pprof
</span><span class='line'>            FAIL: sync/atomic
</span><span class='line'>            FAIL: text/scanner
</span><span class='line'>            FAIL: text/tabwriter
</span><span class='line'>            FAIL: text/template
</span><span class='line'>            FAIL: text/template/parse
</span><span class='line'>            FAIL: testing/quick
</span><span class='line'>            FAIL: unicode/utf16
</span><span class='line'>            FAIL: unicode/utf8
</span><span class='line'>
</span><span class='line'>                    === libgo Summary ===
</span><span class='line'>
</span><span class='line'># of expected passes        1
</span><span class='line'># of unexpected failures    130
</span><span class='line'>/root/gcc_new/gccbuild/./gcc/gccgo version 4.9.0 20130606 (experimental) (GCC)</span></code></pre></td></tr></table></div></figure>


<p><strong>Oh boy!</strong> Oh boy! Well, on second thoughts, this was not unexpected.
<strong>This was the core of my GSOC work</strong>. This is how it starts :)</p>

<p>Before this goes any further, maybe we should visit the Linux test results too.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>Test Run By fotis on  02  2013 09:20:20  EEST
</span><span class='line'>Native configuration is i686-pc-linux-gnu
</span><span class='line'>
</span><span class='line'>        === libgo tests ===
</span><span class='line'>
</span><span class='line'>        Schedule of variations:
</span><span class='line'>            unix
</span><span class='line'>
</span><span class='line'>            Running target unix
</span><span class='line'>            Running ../../../gcc/libgo/libgo.exp ...
</span><span class='line'>            PASS: bufio
</span><span class='line'>            PASS: bytes
</span><span class='line'>            ...
</span><span class='line'>
</span><span class='line'>                    === libgo Summary ===
</span><span class='line'>
</span><span class='line'># of expected passes        131
</span><span class='line'>/home/fotis/Software/gcc_build/./gcc/gccgo version 4.9.0 20130702 (experimental) (GCC)</span></code></pre></td></tr></table></div></figure>


<p>Wow. Considering the results from the Hurd, they really are <strong>not</strong> unexpected. <a href="http://darnassus.sceen.net/~hurd-web/open_issues/gccgo/">Remember
that <strong>getcontext, makecontext, setcontext and swapcontext</strong> are not working as expected.</a></p>

<p>And recalling from an email from Ian Lance Taylor (the GCCgo maintainer, and a member of the Go team)
early in the summer:</p>

<blockquote><p>Go does require switching stacks.  A port of Go that doesn&rsquo;t support
goroutines would be useless&mdash;nothing in the standard library would
work</p></blockquote>

<h1>Conclusion / Work for next week.</h1>

<p><strong>So now it comes down to work on implementing correctly the context switching functions.</strong>
Apart from that, going through the test results that fail from gccgo is also something that
is to be done, however I am not sure that it should be a first priority. I also have to go
through go.log to see if there any clues as to why the gccgo tests fail.</p>

<p>Having finally built gccgo on the Hurd, and <strong>more importantly still being on schedule,
(the original one, from my proposal) means that I can now concentrate on the core part of my
project proposal (and the most exciting one too)</strong>, that is proper implementation
of what is <em>blocking effective context switching, which
in its part is blocking goroutines, without which, the go library will not work properly.</em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hello World]]></title>
    <link href="http://NlightNFotis.github.io/blog/2013/07/14/hello-world/"/>
    <updated>2013-07-14T12:24:00+03:00</updated>
    <id>http://NlightNFotis.github.io/blog/2013/07/14/hello-world</id>
    <content type="html"><![CDATA[<h1>A new beginning</h1>

<p>Oh boy! A new start. Isn&rsquo;t that exciting? You bet it is. It&rsquo;s not however
my first introduction to blogging. I used to have a <a href="http://lambdareflection.wordpress.com">blog</a>
on Wordpress.com, but after a while I was turned off by the fact that it felt too limited.
So I decided I wanted a new place for me to host my online presence, that wasn&rsquo;t so much limited as Wordpress was.
Initially I was thinking about renting a VPS and self hosting wordpress there. But after doing a little research,
I came across <a href="http://pages.github.com">Github Pages</a>. I started investigating
Github pages some more, and found <a href="http://jekyllrb.com">jekyll</a> to be very <strong>very</strong> interesting.
After a while, I also came across <a href="http://octopress.org">Octopress</a>. That was it. I was sold :)</p>

<p>Free hosting of a blog, no need to maintain a server, and a platform written in <a href="http://www.ruby-lang.org">ruby</a>?</p>

<p>Without hesitation, I immediately started working on it. I went through octopress documentation, (which needless to say, but it was fantastic)
found a wonderful theme online at <a href="http://opthemes.com">opthemes</a>, (kudos to <a href="http://alexgaribay.com">Alex Garibay</a> for that)
and got started.</p>

<p>And here we are. On a platform that you can hack and customize to your liking &ndash; at least more so than the locked down version of wordpress.
On a platform that is written on a language that I don&rsquo;t hate with passion (like cough, <strong>php</strong>, cough),
and may actually learn in the future, just for the sake of being able to customize every bit of it (gotta love the hacker&rsquo;s way)
&ndash; even though I am not really interested in web development per se.</p>

<p>Hope it starts out nice. I guess that is left to be seen.</p>
]]></content>
  </entry>
  
</feed>
